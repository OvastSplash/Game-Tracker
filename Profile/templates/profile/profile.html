{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="profile-container">
    <div class="dashboard-layout">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (–ª–µ–≤–∞—è —á–∞—Å—Ç—å) -->
        <div class="main-content">
            <div class="content-wrapper">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <h1 class="profile-title">{{ user.username }}</h1>
                </div>
                
                <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–æ—Ñ–∏–ª—è -->
                <div class="profile-stats">
                    <div class="stat-card">
                        <i class="fas fa-gamepad stat-icon"></i>
                        <div class="stat-info">
                            <h3>–ò–≥—Ä –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</h3>
                            <p class="stat-value">{{ games_count }}</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-circle stat-icon"></i>
                        <div class="stat-info">
                            <h3>–ü—Ä–æ–π–¥–µ–Ω–æ –∏–≥—Ä</h3>
                            <p class="stat-value">{{ games_ended }}</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-hourglass-half stat-icon"></i>
                        <div class="stat-info">
                            <h3>–í –ø—Ä–æ—Ü–µ—Å—Å–µ</h3>
                            <p class="stat-value">{{ games_in_progress }}</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-list-check stat-icon"></i>
                        <div class="stat-info">
                            <h3>–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –ø—Ä–æ–π—Ç–∏</h3>
                            <p class="stat-value">{{ games_not_started }}</p>
                        </div>
                    </div>
                </div>
                <!-- –ë–ª–æ–∫ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞ –∏–≥—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                <div class="user-games-section mt-4">
                    <div class="user-games-header">
                        <h2 class="user-games-title">–ú–æ–∏ –∏–≥—Ä—ã</h2>
                        <div class="user-games-search">
                            <div class="user-search-wrapper">
                                <i class="fas fa-search user-search-icon"></i>
                                <input type="text" 
                                       id="userGamesSearch" 
                                       class="user-search-input" 
                                       placeholder="–ü–æ–∏—Å–∫ —Å—Ä–µ–¥–∏ –≤–∞—à–∏—Ö –∏–≥—Ä..."
                                       autocomplete="off">
                                <button class="user-search-clear" id="clearUserSearch" onclick="clearUserGamesSearch()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="userGamesList" class="user-games-list"></div>
                </div>
            </div>
        </div>

        <!-- –ü–æ–∏—Å–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ (–ø—Ä–∞–≤–∞—è —á–∞—Å—Ç—å) -->
        <div class="search-sidebar">
            <div class="content-wrapper">
                <h2 class="search-title">
                    <i class="fas fa-search"></i>
                    –ü–æ–∏—Å–∫ –∏–≥—Ä
                </h2>
                
                <div class="search-container position-relative">
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" 
                               id="gameSearch" 
                               class="search-input" 
                               placeholder="–ü–æ–∏—Å–∫ –∏–≥—Ä..."
                               autocomplete="off">
                    </div>
                    <div id="searchResults" class="search-results">
                        <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ -->
<div id="statusModal" class="status-modal">
    <div class="status-modal-content">
        <div class="status-modal-header">
            <h3 class="status-modal-title">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏–≥—Ä—ã</h3>
            <p class="status-modal-game-name" id="modalGameName"></p>
        </div>
        
        <div class="status-options">
            <div class="status-option plan" data-status="PLAN_TO_PLAY">
                <div class="status-option-icon">
                    <i class="fas fa-list-check"></i>
                </div>
                <div class="status-option-text">–ü–ª–∞–Ω–∏—Ä—É—é –ø—Ä–æ–π—Ç–∏</div>
            </div>
            
            <div class="status-option playing" data-status="PLAYING">
                <div class="status-option-icon">
                    <i class="fas fa-hourglass-half"></i>
                </div>
                <div class="status-option-text">–ü—Ä–æ—Ö–æ–∂—É</div>
            </div>
            
            <div class="status-option completed" data-status="COMPLETED">
                <div class="status-option-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="status-option-text">–ü—Ä–æ–π–¥–µ–Ω–∞</div>
            </div>
        </div>
        
        <div class="status-modal-actions">
            <button class="modal-btn modal-btn-cancel" onclick="closeStatusModal()">
                –û—Ç–º–µ–Ω–∞
            </button>
            <button class="modal-btn modal-btn-save" id="saveStatusBtn" onclick="saveGameStatus()">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
        </div>
    </div>
</div>

<style>
    :root {
        --primary-dark: #0a0a0a;
        --secondary-dark: #1a1a1a;
        --accent-color: #00ff88;
        --accent-secondary: #ff6b35;
        --accent-purple: #a855f7;
        --text-color: #ffffff;
        --text-secondary: #a3a3a3;
        --text-muted: #6b7280;
        --background-gradient: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f1419 100%);
        --card-gradient: linear-gradient(145deg, rgba(255, 255, 255, 0.02) 0%, rgba(255, 255, 255, 0.08) 100%);
        --glow-green: 0 0 20px rgba(0, 255, 136, 0.3);
        --glow-orange: 0 0 20px rgba(255, 107, 53, 0.3);
        --glow-purple: 0 0 20px rgba(168, 85, 247, 0.3);
    }

    .profile-container {
        min-height: 100vh;
        background: var(--background-gradient);
        padding: 1rem;
        font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
        position: relative;
        overflow-x: hidden;
    }

    .profile-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 20% 80%, rgba(0, 255, 136, 0.05) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255, 107, 53, 0.05) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(168, 85, 247, 0.05) 0%, transparent 50%);
        pointer-events: none;
    }

    .dashboard-layout {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 2rem;
        max-width: 1600px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
    }

    .content-wrapper {
        background: var(--secondary-dark);
        padding: 2.5rem;
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 
            0 20px 50px rgba(0, 0, 0, 0.5),
            inset 0 1px 0 rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(15px);
        min-height: 20vh; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É */
    }

    .content-wrapper::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, 
            var(--accent-color) 0%, 
            var(--accent-secondary) 50%, 
            var(--accent-purple) 100%);
        opacity: 0.6;
    }

    .profile-header {
        text-align: center;
        margin-bottom: 3rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        position: relative;
    }

    .profile-avatar {
        font-size: 6rem;
        background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 1rem;
        filter: drop-shadow(0 4px 8px rgba(0, 255, 136, 0.3));
        animation: pulse-glow 3s ease-in-out infinite alternate;
    }

    @keyframes pulse-glow {
        0% { filter: drop-shadow(0 4px 8px rgba(0, 255, 136, 0.3)); }
        100% { filter: drop-shadow(0 8px 16px rgba(0, 255, 136, 0.5)); }
    }

    .profile-title {
        color: var(--text-color);
        font-size: 2.5rem;
        font-weight: 800;
        margin: 0;
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        letter-spacing: -0.02em;
        background: linear-gradient(45deg, #ffffff, #a3a3a3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .profile-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .stat-card {
        background: var(--card-gradient);
        border-radius: 16px;
        padding: 2rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.08);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.02), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: var(--glow-green);
        border-color: rgba(0, 255, 136, 0.3);
    }

    .stat-card:hover::before {
        opacity: 1;
    }

    .stat-card:nth-child(1):hover { box-shadow: var(--glow-green); }
    .stat-card:nth-child(2):hover { box-shadow: var(--glow-orange); }
    .stat-card:nth-child(3):hover { box-shadow: var(--glow-purple); }
    .stat-card:nth-child(4):hover { box-shadow: 0 0 20px rgba(6, 182, 212, 0.3); }

    .stat-icon {
        font-size: 2.5rem;
        background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        transition: all 0.3s ease;
    }

    .stat-card:nth-child(1) .stat-icon {
        background: linear-gradient(45deg, var(--accent-color), #00d9ff);
    }
    .stat-card:nth-child(2) .stat-icon {
        background: linear-gradient(45deg, var(--accent-secondary), #ff8c42);
    }
    .stat-card:nth-child(3) .stat-icon {
        background: linear-gradient(45deg, var(--accent-purple), #c084fc);
    }
    .stat-card:nth-child(4) .stat-icon {
        background: linear-gradient(45deg, #06b6d4, #0891b2);
    }

    .stat-info h3 {
        color: var(--text-secondary);
        font-size: 0.85rem;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .stat-value {
        color: var(--text-color);
        font-size: 2rem;
        font-weight: 800;
        margin: 0.5rem 0 0 0;
        min-width: 2ch;
        transition: all 0.3s ease;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        line-height: 1;
    }

    .search-sidebar {
        position: relative;
    }

    .search-title {
        color: var(--text-color);
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .search-title i {
        color: var(--accent-color);
    }

    .search-container {
        width: 100%;
    }

    .search-wrapper {
        position: relative;
        margin-bottom: 1rem;
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 1.2rem;
    }

    .search-input {
        width: 100%;
        padding: 1rem 1rem 1rem 3rem;
        background: var(--secondary-dark);
        border: 2px solid transparent;
        border-radius: 10px;
        color: var(--text-color);
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 15px rgba(0, 200, 255, 0.2);
    }

    .search-results {
        position: absolute;
        top: calc(100% + 5px);
        left: 0;
        right: 0;
        background: var(--secondary-dark);
        border-radius: 10px;
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .game-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }

    .game-item:last-child {
        border-bottom: none;
    }

    .game-item:hover {
        background: rgba(0, 200, 255, 0.1);
    }

    .game-image {
        width: 80px;
        height: 45px;
        object-fit: cover;
        border-radius: 5px;
        margin-right: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .game-info {
        flex-grow: 1;
        min-width: 0;
    }

    .game-title {
        margin: 0;
        color: var(--text-color);
        font-size: 0.9rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .game-meta {
        color: var(--text-secondary);
        font-size: 0.8rem;
        margin-top: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .metacritic-score {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        border-radius: 5px;
        font-weight: bold;
        font-size: 0.8rem;
        min-width: 32px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .add-game-btn {
        background: none;
        border: none;
        color: var(--accent-color);
        padding: 0.5rem;
        margin-left: 0.5rem;
        transition: all 0.3s ease;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .add-game-btn:hover {
        background: rgba(0, 200, 255, 0.1);
        transform: scale(1.1);
    }

    /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
    .search-results::-webkit-scrollbar {
        width: 8px;
    }

    .search-results::-webkit-scrollbar-track {
        background: var(--primary-dark);
        border-radius: 4px;
    }

    .search-results::-webkit-scrollbar-thumb {
        background: var(--accent-color);
        border-radius: 4px;
    }

    .search-results::-webkit-scrollbar-thumb:hover {
        background: #00a0ff;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .content-wrapper {
        animation: fadeInUp 0.6s ease-out;
    }

    .user-games-section {
        margin-top: 2rem;
    }
    
    .user-games-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .user-games-title {
        color: var(--text-color);
        font-size: 2rem;
        margin: 0;
        font-weight: 800;
        letter-spacing: -0.02em;
        background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        position: relative;
    }
    
    .user-games-title::after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 0;
        width: 60px;
        height: 3px;
        background: linear-gradient(90deg, var(--accent-color), var(--accent-secondary));
        border-radius: 2px;
    }

    .user-games-search {
        flex: 1;
        max-width: 400px;
        min-width: 280px;
    }

    .user-search-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .user-search-input {
        width: 100%;
        padding: 0.875rem 2.5rem 0.875rem 3rem;
        background: rgba(255, 255, 255, 0.06);
        border: 2px solid rgba(255, 255, 255, 0.12);
        border-radius: 14px;
        color: var(--text-color);
        font-size: 0.95rem;
        font-weight: 500;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        box-shadow: 
            inset 0 2px 4px rgba(0, 0, 0, 0.2),
            0 1px 0 rgba(255, 255, 255, 0.08);
    }

    .user-search-input::placeholder {
        color: var(--text-muted);
        font-weight: 400;
    }

    .user-search-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 
            0 0 0 3px rgba(0, 255, 136, 0.15),
            inset 0 2px 4px rgba(0, 0, 0, 0.1),
            0 1px 0 rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.08);
    }

    .user-search-icon {
        position: absolute;
        left: 1rem;
        color: var(--accent-color);
        font-size: 1rem;
        opacity: 0.8;
        transition: all 0.3s ease;
        pointer-events: none;
    }

    .user-search-wrapper:focus-within .user-search-icon {
        opacity: 1;
        transform: scale(1.1);
        filter: drop-shadow(0 0 6px rgba(0, 255, 136, 0.4));
    }

    .user-search-clear {
        position: absolute;
        right: 0.75rem;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        opacity: 0;
        transform: scale(0.8);
        font-size: 0.85rem;
    }

    .user-search-clear.show {
        opacity: 1;
        transform: scale(1);
    }

    .user-search-clear:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-color);
    }
    
    .user-games-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
        gap: 2.5rem;
    }
    
    .user-game-card {
        background: var(--card-gradient);
        border-radius: 24px;
        box-shadow: 
            0 15px 40px rgba(0, 0, 0, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
        padding: 0;
        display: flex;
        flex-direction: column;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        min-height: 480px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        overflow: hidden;
        backdrop-filter: blur(20px);
    }
    
    .user-game-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.02), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .user-game-card:hover {
        transform: translateY(-12px) scale(1.02);
        box-shadow: 
            0 20px 50px rgba(0, 0, 0, 0.4),
            var(--glow-green),
            inset 0 1px 0 rgba(255, 255, 255, 0.15);
        border-color: rgba(0, 255, 136, 0.3);
    }
    
    .user-game-card:hover::before {
        opacity: 1;
    }
    
    .user-game-img {
        width: 100%;
        height: 260px;
        object-fit: cover;
        border-radius: 24px 24px 0 0;
        transition: all 0.3s ease;
        position: relative;
        cursor: pointer;
    }
    
    .user-game-card:hover .user-game-img {
        transform: scale(1.05);
        filter: brightness(1.1);
    }
    
    .user-game-content {
        padding: 2rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }
    
    .user-game-title {
        color: var(--text-color);
        font-size: 1.5rem;
        font-weight: 800;
        margin: 0;
        line-height: 1.2;
        cursor: pointer;
        transition: all 0.3s ease;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        word-break: break-word;
        hyphens: auto;
    }
    
    .user-game-title:hover {
        color: var(--accent-color);
        text-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
        transform: translateY(-2px);
    }
    
    .user-game-status {
        font-size: 0.9rem;
        font-weight: 700;
        padding: 0.75rem 1.25rem;
        border-radius: 16px;
        display: inline-block;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        cursor: pointer;
        transition: all 0.3s ease;
        align-self: flex-start;
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
    }
    
    .user-game-status::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }
    
    .user-game-status:hover {
        transform: scale(1.08) translateY(-2px);
        border-color: rgba(255, 255, 255, 0.3);
    }
    
    .user-game-status:hover::before {
        left: 100%;
    }
    
    .user-game-status.completed {
        background: linear-gradient(45deg, #10b981, #059669);
        color: #ffffff;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .user-game-status.playing {
        background: linear-gradient(45deg, #f59e0b, #d97706);
        color: #ffffff;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    }
    
    .user-game-status.plan {
        background: linear-gradient(45deg, #6b7280, #4b5563);
        color: #ffffff;
        box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
    }
    
    .user-game-rating {
        color: var(--text-secondary);
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-top: auto;
        padding: 0.75rem 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        transition: all 0.3s ease;
    }
    
    .user-game-rating:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.15);
    }
    
    .user-game-rating i {
        color: #fbbf24;
        font-size: 1.2rem;
        filter: drop-shadow(0 0 5px rgba(251, 191, 36, 0.4));
    }

    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
    .notification {
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: var(--secondary-dark);
        border-radius: 15px;
        padding: 1rem 1.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        transform: translateX(120%);
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        border-left: 4px solid var(--accent-color);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        gap: 1rem;
        min-width: 300px;
        max-width: 400px;
    }

    .notification.show {
        transform: translateX(0);
    }

    .notification.success {
        border-left-color: #2ecc71;
    }

    .notification.error {
        border-left-color: #e74c3c;
    }

    .notification-icon {
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .notification.success .notification-icon {
        color: #2ecc71;
    }

    .notification.error .notification-icon {
        color: #e74c3c;
    }

    .notification-content {
        flex-grow: 1;
    }

    .notification-title {
        font-weight: 600;
        color: var(--text-color);
        margin: 0 0 0.25rem 0;
        font-size: 1rem;
    }

    .notification-message {
        color: var(--text-secondary);
        margin: 0;
        font-size: 0.9rem;
    }

    .notification-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 50%;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    .notification-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-color);
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ */
    .status-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 10001;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
    }

    .status-modal.show {
        display: flex;
    }

    .status-modal-content {
        background: var(--card-gradient);
        border-radius: 24px;
        padding: 2.5rem;
        max-width: 450px;
        width: 90%;
        box-shadow: 
            0 25px 60px rgba(0, 0, 0, 0.6),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.08);
        transform: scale(0.8) translateY(50px);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        backdrop-filter: blur(20px);
        position: relative;
        overflow: hidden;
    }

    .status-modal-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, 
            var(--accent-color) 0%, 
            var(--accent-secondary) 50%, 
            var(--accent-purple) 100%);
        opacity: 0.8;
    }

    .status-modal.show .status-modal-content {
        transform: scale(1) translateY(0);
        opacity: 1;
    }

    .status-modal-header {
        text-align: center;
        margin-bottom: 2rem;
        position: relative;
    }

    .status-modal-title {
        color: var(--text-color);
        font-size: 1.8rem;
        font-weight: 800;
        margin: 0 0 0.75rem 0;
        background: linear-gradient(45deg, var(--text-color), var(--text-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .status-modal-game-name {
        color: var(--accent-color);
        font-size: 1.1rem;
        margin: 0;
        font-weight: 600;
        text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
    }

    .status-options {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        margin-bottom: 2rem;
    }

    .status-option {
        background: rgba(255, 255, 255, 0.03);
        border: 2px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 1.25rem 1.5rem;
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 1.25rem;
        position: relative;
        overflow: hidden;
    }

    .status-option::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.02), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .status-option:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .status-option:hover::before {
        opacity: 1;
    }

    .status-option.plan:hover {
        border-color: rgba(107, 114, 128, 0.5);
        box-shadow: 0 8px 25px rgba(107, 114, 128, 0.2);
    }

    .status-option.playing:hover {
        border-color: rgba(245, 158, 11, 0.5);
        box-shadow: 0 8px 25px rgba(245, 158, 11, 0.2);
    }

    .status-option.completed:hover {
        border-color: rgba(16, 185, 129, 0.5);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2);
    }

    .status-option.selected {
        background: rgba(0, 255, 136, 0.1);
        border-color: var(--accent-color);
        box-shadow: var(--glow-green);
    }

    .status-option-icon {
        font-size: 1.5rem;
        width: 28px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .status-option.plan .status-option-icon {
        color: #6b7280;
    }

    .status-option.playing .status-option-icon {
        color: #f59e0b;
    }

    .status-option.completed .status-option-icon {
        color: #10b981;
    }

    .status-option:hover .status-option-icon {
        transform: scale(1.2);
    }

    .status-option-text {
        flex-grow: 1;
        font-weight: 600;
        font-size: 1.05rem;
    }

    .status-modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        margin-top: 1rem;
    }

    .modal-btn {
        padding: 1rem 2rem;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 0.95rem;
        position: relative;
        overflow: hidden;
    }

    .modal-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transform: translateX(-100%);
        transition: transform 0.6s ease;
    }

    .modal-btn:hover::before {
        transform: translateX(100%);
    }

    .modal-btn-cancel {
        background: transparent;
        color: var(--text-secondary);
        border: 2px solid rgba(255, 255, 255, 0.15);
    }

    .modal-btn-cancel:hover {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-color);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .modal-btn-save {
        background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
        color: white;
        border: 2px solid transparent;
        box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
    }

    .modal-btn-save:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        border-color: rgba(255, 255, 255, 0.2);
    }

    .modal-btn-save:disabled {
        background: linear-gradient(45deg, #4a4a4a, #3a3a3a);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        border-color: transparent;
    }

    .game-delete-btn {
        background: linear-gradient(45deg, #ef4444, #dc2626);
        color: white;
        border: 2px solid transparent;
        border-radius: 16px;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
        font-weight: 700;
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        position: relative;
        overflow: hidden;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .game-delete-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }
    
    .game-delete-btn:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 12px 30px rgba(239, 68, 68, 0.6);
        border-color: rgba(255, 255, 255, 0.3);
    }
    
    .game-delete-btn:hover::before {
        left: 100%;
    }
    
    .game-delete-btn:active {
        transform: translateY(-1px) scale(1.02);
    }
    
    .game-delete-btn i {
        margin-right: 0.5rem;
    }

    .search-title {
        color: var(--text-color);
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .search-wrapper {
        position: relative;
        margin-bottom: 1rem;
    }

    .search-input {
        width: 100%;
        padding: 1.25rem 1.25rem 1.25rem 3.5rem;
        background: rgba(255, 255, 255, 0.08);
        border: 2px solid rgba(255, 255, 255, 0.15);
        border-radius: 16px;
        color: var(--text-color);
        font-size: 1.05rem;
        font-weight: 500;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        box-shadow: 
            inset 0 2px 4px rgba(0, 0, 0, 0.2),
            0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .search-input::placeholder {
        color: var(--text-muted);
        font-weight: 400;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 
            0 0 0 3px rgba(0, 255, 136, 0.15),
            inset 0 2px 4px rgba(0, 0, 0, 0.1),
            0 1px 0 rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.12);
    }

    .search-icon {
        position: absolute;
        left: 1.25rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--accent-color);
        font-size: 1.2rem;
        opacity: 0.8;
        transition: all 0.3s ease;
    }

    .search-wrapper:focus-within .search-icon {
        opacity: 1;
        transform: translateY(-50%) scale(1.1);
        filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.4));
    }

    .search-results {
        background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
        border-radius: 16px;
        border: 2px solid rgba(0, 255, 136, 0.3);
        backdrop-filter: blur(20px);
        max-height: 80vh;
        min-height: 600px;
        height: auto;
        overflow-y: auto;
        display: none;
        position: absolute;
        top: 100%;
        width: 500px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10000;
        box-shadow: 
            0 20px 40px rgba(0, 0, 0, 0.8),
            0 0 0 1px rgba(255, 255, 255, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.15);
        margin-top: 0.5rem;
    }

    /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ */
    .search-results::-webkit-scrollbar {
        width: 8px;
    }

    .search-results::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }

    .search-results::-webkit-scrollbar-thumb {
        background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .search-results::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(45deg, var(--accent-secondary), var(--accent-color));
        box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
    }

    .game-item {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        padding: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        position: relative;
        min-height: 110px;
        background: rgba(255, 255, 255, 0.02);
        margin: 0.5rem;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .game-item:hover {
        background: rgba(0, 255, 136, 0.12);
        border-color: rgba(0, 255, 136, 0.4);
        transform: translateX(8px) scale(1.02);
        box-shadow: 
            0 8px 25px rgba(0, 255, 136, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .game-item:last-child {
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    }

    .game-image {
        width: 100px;
        height: 60px;
        object-fit: cover;
        border-radius: 12px;
        flex-shrink: 0;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        border: 2px solid rgba(255, 255, 255, 0.15);
        transition: all 0.3s ease;
    }

    .game-item:hover .game-image {
        transform: scale(1.05);
        box-shadow: 0 12px 30px rgba(0, 255, 136, 0.3);
        border-color: rgba(0, 255, 136, 0.5);
    }

    .game-info {
        flex-grow: 1;
        min-width: 0;
    }

    .game-title {
        color: var(--text-color);
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0 0 0.5rem 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        line-height: 1.3;
        cursor: pointer;
        transition: all 0.3s ease;
        background: linear-gradient(45deg, var(--text-color), rgba(255, 255, 255, 0.8));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .game-title:hover {
        background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
        transform: translateX(5px);
    }

    .game-meta {
        color: var(--text-secondary);
        font-size: 0.95rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-weight: 500;
        opacity: 0.85;
        line-height: 1.4;
        padding: 0.25rem 0;
        transition: all 0.3s ease;
    }

    .game-item:hover .game-meta {
        color: rgba(255, 255, 255, 0.9);
        opacity: 1;
    }

    .add-game-btn {
        background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.25);
        border-radius: 14px;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        flex-shrink: 0;
        font-size: 1.3rem;
        font-weight: 700;
        box-shadow: 
            0 6px 20px rgba(0, 255, 136, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.2);
        position: relative;
        overflow: hidden;
    }

    .add-game-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .add-game-btn:hover {
        transform: scale(1.15) rotate(90deg);
        box-shadow: 
            0 10px 35px rgba(0, 255, 136, 0.6),
            0 0 0 3px rgba(0, 255, 136, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
    }

    .add-game-btn:hover::before {
        left: 100%;
    }

    .add-game-btn:active {
        transform: scale(1.05) rotate(90deg);
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 1600px) {
        .user-games-list {
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
        }
    }

    @media (max-width: 1400px) {
        .dashboard-layout {
            grid-template-columns: 1fr 350px;
        }
        
        .user-games-list {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }
    }

    @media (max-width: 1200px) {
        .dashboard-layout {
            grid-template-columns: 1fr 320px;
        }
        
        .user-games-list {
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }
    }

    @media (max-width: 991px) {
        .dashboard-layout {
            grid-template-columns: 1fr;
        }

        .search-sidebar {
            order: -1;
        }

        .profile-container {
            padding: 1rem;
        }
        
        .user-games-list {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        .user-game-card {
            min-height: 420px;
        }
        
        .user-game-img {
            height: 220px;
        }
    }

    .notification {
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: var(--card-gradient);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 1.5rem;
        min-width: 320px;
        max-width: 400px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(20px);
        z-index: 10000;
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }

    .notification.show {
        transform: translateX(0);
        opacity: 1;
    }

    .notification.success {
        border-left: 4px solid var(--accent-color);
    }

    .notification.error {
        border-left: 4px solid #ef4444;
    }

    .notification-icon {
        flex-shrink: 0;
        font-size: 1.5rem;
    }

    .notification.success .notification-icon {
        color: var(--accent-color);
    }

    .notification.error .notification-icon {
        color: #ef4444;
    }

    .notification-content {
        flex-grow: 1;
    }

    .notification-title {
        color: var(--text-color);
        font-weight: 700;
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }

    .notification-message {
        color: var(--text-secondary);
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .notification-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    .notification-close:hover {
        color: var(--text-color);
        background: rgba(255, 255, 255, 0.1);
    }

    @media (max-width: 768px) {
        .profile-stats {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .user-games-list {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        .user-game-card {
            min-height: 380px;
        }
        
        .user-game-img {
            height: 200px;
        }
        
        .user-game-content {
            padding: 1.5rem;
        }
        
        .user-game-title {
            font-size: 1.3rem;
        }
    }

    @media (max-width: 480px) {
        .profile-stats {
            grid-template-columns: 1fr;
        }
        
        .user-games-list {
            grid-template-columns: 1fr;
            gap: 1.25rem;
        }
        
        .user-game-card {
            min-height: 350px;
        }
        
        .user-game-img {
            height: 180px;
        }
        
        .user-game-content {
            padding: 1.25rem;
            gap: 1rem;
        }
        
        .user-game-title {
            font-size: 1.2rem;
        }
        
        .game-delete-btn {
            padding: 0.75rem 1.25rem;
            font-size: 0.9rem;
        }

        .notification {
            top: 1rem;
            right: 1rem;
            left: 1rem;
            min-width: auto;
            max-width: none;
        }
        
        .profile-title {
            font-size: 2rem;
        }
        
        .user-games-title {
            font-size: 1.5rem;
        }
    }
</style>

<script>
let searchTimeout;

function getJWTToken() {
    return localStorage.getItem('jwt_token');
}

const statusMap = {
    'PLAN_TO_PLAY': {text: '–ü–ª–∞–Ω–∏—Ä—É—é –∏–≥—Ä–∞—Ç—å', class: 'plan'},
    'PLAYING': {text: '–ò–≥—Ä–∞—é', class: 'playing'},
    'COMPLETED': {text: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ', class: 'completed'},
};

function renderUserGames(games) {
    const container = document.getElementById('userGamesList');
    container.innerHTML = '';
    if (!games.length) {
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; font-size: 1.4rem; margin: 4rem 0; font-weight: 600;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ üéÆ</p>';
        return;
    }
    games.forEach(obj => {
        const game = obj.game;
        const status = statusMap[obj.status] || {text: obj.status, class: ''};
        const div = document.createElement('div');
        div.className = 'user-game-card';
        div.setAttribute('data-game-id', game.id || game.slug);
        div.innerHTML = `
            <img class="user-game-img" src="${game.logo}" alt="${game.name}" onclick="navigateToGamePage('${game.slug}')" title="–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–∏—Å–∞–Ω–∏—é –∏–≥—Ä—ã">
            <div class="user-game-content">
                <h3 class="user-game-title" data-slug="${game.slug}" title="–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–∏—Å–∞–Ω–∏—é –∏–≥—Ä—ã">${game.name}</h3>
                <span class="user-game-status ${status.class}" onclick="openStatusModal('${game.slug}', '${game.name}', '${obj.status}')" title="–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏–≥—Ä—ã">
                    ${status.text}
                </span>
                ${obj.user_raiting ? `<div class="user-game-rating"><i class="fas fa-star"></i> –û—Ü–µ–Ω–∫–∞: ${obj.user_raiting}/10</div>` : '<div class="user-game-rating"><i class="fas fa-star-o"></i> –ù–µ –æ—Ü–µ–Ω–µ–Ω–∞</div>'}
                <button class="game-delete-btn" onclick="deleteGameFromCollection('${game.slug}')" title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏">
                    <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                </button>
            </div>
        `;
        container.appendChild(div);
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π –∏–≥—Ä
    container.querySelectorAll('.user-game-title').forEach(title => {
        title.addEventListener('click', function() {
            const slug = this.getAttribute('data-slug');
            navigateToGamePage(slug);
        });
    });
}

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∏–≥—Ä
let allUserGames = [];
let filteredUserGames = [];

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ —Å—Ä–µ–¥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∏–≥—Ä
function filterUserGames(searchQuery) {
    if (!searchQuery.trim()) {
        filteredUserGames = [...allUserGames];
    } else {
        const query = searchQuery.toLowerCase().trim();
        filteredUserGames = allUserGames.filter(gameObj => 
            gameObj.game.name.toLowerCase().includes(query)
        );
    }
    renderUserGames(filteredUserGames);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∏–≥—Ä
function clearUserGamesSearch() {
    const searchInput = document.getElementById('userGamesSearch');
    const clearBtn = document.getElementById('clearUserSearch');
    
    searchInput.value = '';
    clearBtn.classList.remove('show');
    searchInput.focus();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∏–≥—Ä—ã
    filterUserGames('');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∏–≥—Ä
function initUserGamesSearch() {
    const searchInput = document.getElementById('userGamesSearch');
    const clearBtn = document.getElementById('clearUserSearch');
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏
            if (query.length > 0) {
                clearBtn.classList.add('show');
            } else {
                clearBtn.classList.remove('show');
            }
            
            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫
            filterUserGames(query);
        });
    }
}

window.addEventListener('DOMContentLoaded', function() {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º access —Ç–æ–∫–µ–Ω –≤ localStorage, –µ—Å–ª–∏ –æ–Ω –ø–µ—Ä–µ–¥–∞–Ω –∏–∑ views
    {% if access_token %}
        localStorage.setItem('jwt_token', '{{ access_token }}');
    {% endif %}
    
    const userGames = {{ user_games_json|safe }};
    allUserGames = [...userGames];
    filteredUserGames = [...userGames];
    renderUserGames(userGames);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∏–≥—Ä
    initUserGamesSearch();
    
    // –ê–Ω–∏–º–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    animateCounters();
});

// –§—É–Ω–∫—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ —Å—á–µ—Ç—á–∏–∫–æ–≤
function animateCounters() {
    const counters = document.querySelectorAll('.stat-value');
    
    counters.forEach(counter => {
        const target = parseInt(counter.textContent);
        counter.textContent = '0';
        
        const increment = target / 50;
        let current = 0;
        
        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                counter.textContent = target;
                clearInterval(timer);
            } else {
                counter.textContent = Math.floor(current);
            }
        }, 20);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(type, title, message) {
    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    const iconClass = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
    
    notification.innerHTML = `
        <div class="notification-icon">
            <i class="${iconClass}"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title">${title}</div>
            <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close" onclick="hideNotification(this)">
            <i class="fas fa-times"></i>
        </button>
    `;

    document.body.appendChild(notification);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        hideNotification(notification);
    }, 5000);
}

function hideNotification(element) {
    const notification = element.closest ? element.closest('.notification') : element;
    notification.classList.remove('show');
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 400);
}

document.getElementById('gameSearch').addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    const searchQuery = e.target.value.trim();
    const resultsContainer = document.getElementById('searchResults');
    
    if (searchQuery.length > 0) {
        resultsContainer.style.display = 'block';
        searchTimeout = setTimeout(() => {
            fetchGames(searchQuery);
        }, 300);
    } else {
        resultsContainer.style.display = 'none';
    }
});

document.addEventListener('click', function(e) {
    const searchContainer = document.querySelector('.search-container');
    const resultsContainer = document.getElementById('searchResults');
    if (!searchContainer.contains(e.target)) {
        resultsContainer.style.display = 'none';
    }
});

function fetchGames(query) {
    const resultsContainer = document.getElementById('searchResults');
    
         // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
     resultsContainer.innerHTML = `
         <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
             <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--accent-color); margin-bottom: 1rem; display: block;"></i>
             <p style="margin: 0; font-size: 1.1rem; font-weight: 600;">–ü–æ–∏—Å–∫ –∏–≥—Ä...</p>
             <p style="margin: 0.5rem 0 0; font-size: 0.9rem; opacity: 0.7;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
         </div>
     `;
    
    fetch(`/api/gameList/${encodeURIComponent(query)}/`, {
        headers: {
            'Authorization': 'Bearer ' + getJWTToken()
        }
    })
        .then(response => response.json())
        .then(games => {
            resultsContainer.innerHTML = '';
            
                         if (games.length === 0) {
                 resultsContainer.innerHTML = `
                     <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                         <i class="fas fa-search" style="font-size: 2rem; color: var(--accent-color); opacity: 0.5; margin-bottom: 1rem; display: block;"></i>
                         <p style="margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--text-color);">–ò–≥—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                         <p style="margin: 0.5rem 0 0; font-size: 0.9rem; opacity: 0.8; line-height: 1.4;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>
                     </div>
                 `;
                 return;
             }
            
            games.forEach(game => {
                const gameElement = createGameElement(game);
                resultsContainer.appendChild(gameElement);
            });
        })
                 .catch(error => {
             console.error('Error:', error);
             resultsContainer.innerHTML = `
                 <div style="padding: 2rem; text-align: center; color: #ef4444;">
                     <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                     <p style="margin: 0; font-size: 1.1rem; font-weight: 700;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</p>
                     <p style="margin: 0.5rem 0 0; font-size: 0.9rem; opacity: 0.8; line-height: 1.4;">–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫.<br>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –ø–æ–∑–∂–µ.</p>
                 </div>
             `;
         });
}

function createGameElement(game) {
    const gameItem = document.createElement('div');
    gameItem.className = 'game-item';
    gameItem.style.cursor = 'pointer';
    gameItem.addEventListener('click', function(e) {
        // –ï—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è, —Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∏–≥—Ä–µ
        if (!e.target.closest('.add-game-btn')) {
            navigateToGamePage(game.slug);
        }
    });
    
    const image = document.createElement('img');
    image.className = 'game-image';
    image.src = game.background_image;
    image.alt = game.name;
    
    const info = document.createElement('div');
    info.className = 'game-info';
    
    const titleRow = document.createElement('div');
    titleRow.style.display = 'flex';
    titleRow.style.justifyContent = 'space-between';
    titleRow.style.alignItems = 'flex-start';
    titleRow.style.width = '100%';
    
    const titleContainer = document.createElement('div');
    titleContainer.style.flex = '1';
    titleContainer.style.minWidth = '0';
    
    const title = document.createElement('h3');
    title.className = 'game-title';
    title.textContent = game.name;
    
    const meta = document.createElement('div');
    meta.className = 'game-meta';
    let metaText = '';
    if (game.genres && game.genres.length > 0) {
        metaText = game.genres.map(g => g.name).join(', ');
    }
    if (game.metacritic) {
        metaText += ` ‚Ä¢ ${game.metacritic}/100`;
    }
    meta.textContent = metaText;
    
    const addButton = document.createElement('button');
    addButton.className = 'add-game-btn';
    addButton.innerHTML = '<i class="fas fa-plus"></i>';
    addButton.title = '–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é';
    addButton.addEventListener('click', function(e) {
        e.stopPropagation();
        addGameToProfile(game.slug);
    });
    
    titleContainer.appendChild(title);
    titleContainer.appendChild(meta);
    titleRow.appendChild(titleContainer);
    titleRow.appendChild(addButton);
    info.appendChild(titleRow);
    gameItem.appendChild(image);
    gameItem.appendChild(info);
    
    return gameItem;
}

function addGameToProfile(slug) {
    fetch(`/api/game/${encodeURIComponent(slug)}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getJWTToken()
        },
        body: JSON.stringify({addGame: true})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('success', '–£—Å–ø–µ—à–Ω–æ!', '–ò–≥—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏–≥—Ä—ã
            updateStatsAfterGameAddition();
            
            fetchUserGames();
        } else {
            showNotification('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä—É –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏–≥—Ä—ã:', error);
        showNotification('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä—É –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é');
    });
}

function fetchUserGames() {
    fetch('/api/user/games/', {
        headers: {
            'Authorization': 'Bearer ' + getJWTToken()
        }
    })
    .then(response => response.json())
    .then(games => {
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤—ã –¥–ª—è –ø–æ–∏—Å–∫–∞
        allUserGames = [...games];
        filteredUserGames = [...games];
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫
        const searchInput = document.getElementById('userGamesSearch');
        if (searchInput && searchInput.value.trim()) {
            filterUserGames(searchInput.value.trim());
        } else {
            renderUserGames(games);
        }
        
        updateStatistics(games);
    })
    .catch(error => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–≥—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error));
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateStatistics(games) {
    const totalGames = games.length;
    const completedGames = games.filter(game => game.status === 'COMPLETED').length;
    const playingGames = games.filter(game => game.status === 'PLAYING').length;
    const planGames = games.filter(game => game.status === 'PLAN_TO_PLAY').length;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    updateCounterValue(document.querySelector('.stat-card:nth-child(1) .stat-value'), totalGames);
    updateCounterValue(document.querySelector('.stat-card:nth-child(2) .stat-value'), completedGames);
    updateCounterValue(document.querySelector('.stat-card:nth-child(3) .stat-value'), playingGames);
    updateCounterValue(document.querySelector('.stat-card:nth-child(4) .stat-value'), planGames);
}

// –§—É–Ω–∫—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞
function updateCounterValue(element, newValue) {
    const currentValue = parseInt(element.textContent);
    if (currentValue === newValue) return;
    
    const increment = (newValue - currentValue) / 20;
    let current = currentValue;
    
    const timer = setInterval(() => {
        current += increment;
        if ((increment > 0 && current >= newValue) || (increment < 0 && current <= newValue)) {
            element.textContent = newValue;
            clearInterval(timer);
        } else {
            element.textContent = Math.floor(current);
        }
    }, 20);
}

function getMetacriticColor(score) {
    if (score >= 75) return '#2ecc71';
    if (score >= 50) return '#f1c40f';
    return '#e74c3c';
}

function deleteGameFromCollection(slug) {
    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å —É–¥–∞–ª—è–µ–º–æ–π –∏–≥—Ä—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
    const gameStatus = getCurrentGameStatus(slug);
    
    fetch('/api/user/games/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getJWTToken()
        },
        body: JSON.stringify({slug: slug})
    })
    .then(response => {
        if (response.status === 204) {
            showNotification('success', '–£—Å–ø–µ—à–Ω–æ!', '–ò–≥—Ä–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–≥—Ä—ã
            updateStatsAfterGameDeletion(gameStatus);
            
            // –£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ - —É–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
            const gameCards = document.querySelectorAll('.user-game-card');
            gameCards.forEach(card => {
                const titleElement = card.querySelector('.user-game-title');
                if (titleElement && titleElement.getAttribute('data-slug') === slug) {
                    card.style.transition = 'all 0.4s ease';
                    card.style.transform = 'scale(0.8) translateY(20px)';
                    card.style.opacity = '0';
                    setTimeout(() => {
                        card.remove();
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â–µ –∏–≥—Ä—ã
                        const remainingCards = document.querySelectorAll('.user-game-card');
                        if (remainingCards.length === 0) {
                            document.getElementById('userGamesList').innerHTML = '<p style="color: var(--text-secondary); text-align: center; font-size: 1.4rem; margin: 4rem 0; font-weight: 600;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ üéÆ</p>';
                        }
                    }, 400);
                }
            });
        } else if (response.status === 404) {
            showNotification('error', '–û—à–∏–±–∫–∞', '–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏');
        } else {
            showNotification('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–≥—Ä—É –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–≥—Ä—ã:', error);
        showNotification('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–≥—Ä—É –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏');
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏–≥—Ä—ã
function updateStatsAfterGameAddition() {
    const counters = {
        total: document.querySelector('.stat-card:nth-child(1) .stat-value'),
        plan: document.querySelector('.stat-card:nth-child(4) .stat-value')
    };
    
    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±—â–∏–π —Å—á–µ—Ç—á–∏–∫
    const totalValue = parseInt(counters.total.textContent);
    updateCounterValue(counters.total, totalValue + 1);
    
    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ "–ü–ª–∞–Ω–∏—Ä—É—é –ø—Ä–æ–π—Ç–∏" (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–æ–≤—ã–µ –∏–≥—Ä—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Å —ç—Ç–∏–º —Å—Ç–∞—Ç—É—Å–æ–º)
    const planValue = parseInt(counters.plan.textContent);
    updateCounterValue(counters.plan, planValue + 1);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–≥—Ä—ã
function updateStatsAfterGameDeletion(deletedGameStatus) {
    const counters = {
        total: document.querySelector('.stat-card:nth-child(1) .stat-value'),
        completed: document.querySelector('.stat-card:nth-child(2) .stat-value'),
        playing: document.querySelector('.stat-card:nth-child(3) .stat-value'),
        plan: document.querySelector('.stat-card:nth-child(4) .stat-value')
    };
    
    // –£–º–µ–Ω—å—à–∞–µ–º –æ–±—â–∏–π —Å—á–µ—Ç—á–∏–∫
    const totalValue = parseInt(counters.total.textContent);
    updateCounterValue(counters.total, totalValue - 1);
    
    // –£–º–µ–Ω—å—à–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å—á–µ—Ç—á–∏–∫ —Å—Ç–∞—Ç—É—Å–∞
    if (deletedGameStatus === 'COMPLETED') {
        const currentValue = parseInt(counters.completed.textContent);
        updateCounterValue(counters.completed, currentValue - 1);
    } else if (deletedGameStatus === 'PLAYING') {
        const currentValue = parseInt(counters.playing.textContent);
        updateCounterValue(counters.playing, currentValue - 1);
    } else if (deletedGameStatus === 'PLAN_TO_PLAY') {
        const currentValue = parseInt(counters.plan.textContent);
        updateCounterValue(counters.plan, currentValue - 1);
    }
}

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞
let currentGameSlug = null;
let selectedStatus = null;

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
function openStatusModal(gameSlug, gameName, currentStatus) {
    currentGameSlug = gameSlug;
    selectedStatus = currentStatus;
    
    document.getElementById('modalGameName').textContent = gameName;
    
    // –°–±—Ä–æ—Å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –æ–ø—Ü–∏–π
    document.querySelectorAll('.status-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
    const currentOption = document.querySelector(`[data-status="${currentStatus}"]`);
    if (currentOption) {
        currentOption.classList.add('selected');
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = document.getElementById('statusModal');
    modal.classList.add('show');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —Ñ–æ–Ω –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
    modal.onclick = function(e) {
        if (e.target === modal) {
            closeStatusModal();
        }
    };
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function closeStatusModal() {
    const modal = document.getElementById('statusModal');
    modal.classList.remove('show');
    currentGameSlug = null;
    selectedStatus = null;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –∏–≥—Ä—ã –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
function getCurrentGameStatus(gameSlug) {
    const gameCards = document.querySelectorAll('.user-game-card');
    for (let card of gameCards) {
        const titleElement = card.querySelector('.user-game-title');
        if (titleElement && titleElement.getAttribute('data-slug') === gameSlug) {
            const statusElement = card.querySelector('.user-game-status');
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ CSS –∫–ª–∞—Å—Å—É
            if (statusElement.classList.contains('completed')) return 'COMPLETED';
            if (statusElement.classList.contains('playing')) return 'PLAYING';
            if (statusElement.classList.contains('plan')) return 'PLAN_TO_PLAY';
        }
    }
    return null;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
function updateStatsAfterStatusChange(gameSlug, oldStatus, newStatus) {
    if (oldStatus === newStatus) return;
    
    const counters = {
        total: document.querySelector('.stat-card:nth-child(1) .stat-value'),
        completed: document.querySelector('.stat-card:nth-child(2) .stat-value'),
        playing: document.querySelector('.stat-card:nth-child(3) .stat-value'),
        plan: document.querySelector('.stat-card:nth-child(4) .stat-value')
    };
    
    // –£–º–µ–Ω—å—à–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å—Ç–∞—Ä–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
    if (oldStatus === 'COMPLETED') {
        const currentValue = parseInt(counters.completed.textContent);
        updateCounterValue(counters.completed, currentValue - 1);
    } else if (oldStatus === 'PLAYING') {
        const currentValue = parseInt(counters.playing.textContent);
        updateCounterValue(counters.playing, currentValue - 1);
    } else if (oldStatus === 'PLAN_TO_PLAY') {
        const currentValue = parseInt(counters.plan.textContent);
        updateCounterValue(counters.plan, currentValue - 1);
    }
    
    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
    if (newStatus === 'COMPLETED') {
        const currentValue = parseInt(counters.completed.textContent);
        updateCounterValue(counters.completed, currentValue + 1);
    } else if (newStatus === 'PLAYING') {
        const currentValue = parseInt(counters.playing.textContent);
        updateCounterValue(counters.playing, currentValue + 1);
    } else if (newStatus === 'PLAN_TO_PLAY') {
        const currentValue = parseInt(counters.plan.textContent);
        updateCounterValue(counters.plan, currentValue + 1);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –∏–≥—Ä—ã –≤ –∫–∞—Ä—Ç–æ—á–∫–µ
function updateGameCardStatus(gameSlug, newStatus) {
    const gameCards = document.querySelectorAll('.user-game-card');
    for (let card of gameCards) {
        const titleElement = card.querySelector('.user-game-title');
        if (titleElement && titleElement.getAttribute('data-slug') === gameSlug) {
            const statusElement = card.querySelector('.user-game-status');
            
            // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã
            statusElement.classList.remove('completed', 'playing', 'plan');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å –∏ —Ç–µ–∫—Å—Ç
            const statusMap = {
                'COMPLETED': { class: 'completed', text: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' },
                'PLAYING': { class: 'playing', text: '–ò–≥—Ä–∞—é' },
                'PLAN_TO_PLAY': { class: 'plan', text: '–ü–ª–∞–Ω–∏—Ä—É—é –∏–≥—Ä–∞—Ç—å' }
            };
            
            const statusInfo = statusMap[newStatus];
            if (statusInfo) {
                statusElement.classList.add(statusInfo.class);
                statusElement.textContent = statusInfo.text;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º onclick —Å –Ω–æ–≤—ã–º —Å—Ç–∞—Ç—É—Å–æ–º
                const gameName = titleElement.textContent;
                statusElement.setAttribute('onclick', `openStatusModal('${gameSlug}', '${gameName}', '${newStatus}')`);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                statusElement.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    statusElement.style.transform = 'scale(1)';
                }, 200);
            }
            break;
        }
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
function saveGameStatus() {
    if (!currentGameSlug || !selectedStatus) {
        showNotification('error', '–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –∏–≥—Ä—ã');
        return;
    }
    
    const saveBtn = document.getElementById('saveStatusBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    
    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ä—ã–π —Å—Ç–∞—Ç—É—Å –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –æ—Ç–∫–∞—Ç–∞
    const oldStatus = getCurrentGameStatus(currentGameSlug);
    
    // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏
    updateStatsAfterStatusChange(currentGameSlug, oldStatus, selectedStatus);
    updateGameCardStatus(currentGameSlug, selectedStatus);
    
    fetch('/api/user/games/', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getJWTToken()
        },
        body: JSON.stringify({
            slug: currentGameSlug,
            status: selectedStatus
        })
    })
    .then(response => {
        if (response.ok) {
            showNotification('success', '–£—Å–ø–µ—à–Ω–æ!', '–°—Ç–∞—Ç—É—Å –∏–≥—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω');
            closeStatusModal();
            // –ù–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∏–≥—Ä - –≤—Å–µ —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ
        } else {
            // –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            updateStatsAfterStatusChange(currentGameSlug, selectedStatus, oldStatus);
            updateGameCardStatus(currentGameSlug, oldStatus);
            return response.json().then(data => {
                throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
            });
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
        showNotification('error', '–û—à–∏–±–∫–∞', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏–≥—Ä—ã');
    })
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –æ–ø—Ü–∏–π —Å—Ç–∞—Ç—É—Å–∞
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.status-option').forEach(option => {
        option.addEventListener('click', function() {
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö –æ–ø—Ü–∏–π
            document.querySelectorAll('.status-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –æ–ø—Ü–∏—é
            this.classList.add('selected');
            selectedStatus = this.getAttribute('data-status');
        });
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeStatusModal();
        }
    });
});

function navigateToGamePage(slug) {
    // –ü—Ä—è–º–æ–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–≥—Ä—ã
    window.location.href = `/profile/game/${encodeURIComponent(slug)}/`;
}
</script>
{% endblock %} 