{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="profile-container">
    <div class="dashboard-layout">
        <!-- Основной контент (левая часть) -->
        <div class="main-content">
            <div class="content-wrapper">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <h1 class="profile-title">{{ user.username }}</h1>
                </div>
                
                <!-- Здесь будет основной контент профиля -->
                <div class="profile-stats">
                    <div class="stat-card">
                        <i class="fas fa-gamepad stat-icon"></i>
                        <div class="stat-info">
                            <h3>Игр в коллекции</h3>
                            <p class="stat-value">{{ games_count }}</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-circle stat-icon"></i>
                        <div class="stat-info">
                            <h3>Пройдено игр</h3>
                            <p class="stat-value">{{ games_ended }}</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-hourglass-half stat-icon"></i>
                        <div class="stat-info">
                            <h3>В процессе</h3>
                            <p class="stat-value">{{ games_in_progress }}</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-list-check stat-icon"></i>
                        <div class="stat-info">
                            <h3>Планируется пройти</h3>
                            <p class="stat-value">{{ games_not_started }}</p>
                        </div>
                    </div>
                </div>
                <!-- Блок для рендера игр пользователя -->
                <div class="user-games-section mt-4">
                    <div class="user-games-header">
                        <h2 class="user-games-title">Мои игры</h2>
                        <div class="user-games-search">
                            <div class="user-search-wrapper">
                                <i class="fas fa-search user-search-icon"></i>
                                <input type="text" 
                                       id="userGamesSearch" 
                                       class="user-search-input" 
                                       placeholder="Поиск среди ваших игр..."
                                       autocomplete="off">
                                <button class="user-search-clear" id="clearUserSearch" onclick="clearUserGamesSearch()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="userGamesList" class="user-games-list"></div>
                </div>
            </div>
        </div>

        <!-- Поисковая система (правая часть) -->
        <div class="search-sidebar">
            <div class="content-wrapper">
                <h2 class="search-title">
                    <i class="fas fa-search"></i>
                    Поиск игр
                </h2>
                
                <div class="search-container position-relative">
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" 
                               id="gameSearch" 
                               class="search-input" 
                               placeholder="Поиск игр..."
                               autocomplete="off">
                    </div>
                    <div id="searchResults" class="search-results">
                        <!-- Здесь будут отображаться результаты поиска -->
                    </div>
                </div>
                
                <!-- Секция рекомендуемых игр -->
                <div class="recommendations-section">
                    <h2 class="recommendations-title">
                        <i class="fas fa-star"></i>
                        Рекомендуемые игры
                    </h2>
                    <div id="recommendationsContainer" class="recommendations-container">
                        <div class="recommendations-loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Загружаем рекомендации...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для изменения статуса -->
<div id="statusModal" class="status-modal">
    <div class="status-modal-content">
        <div class="status-modal-header">
            <h3 class="status-modal-title">Изменить статус игры</h3>
            <p class="status-modal-game-name" id="modalGameName"></p>
        </div>
        
        <div class="status-options">
            <div class="status-option plan" data-status="PLAN_TO_PLAY">
                <div class="status-option-icon">
                    <i class="fas fa-list-check"></i>
                </div>
                <div class="status-option-text">Планирую пройти</div>
            </div>
            
            <div class="status-option playing" data-status="PLAYING">
                <div class="status-option-icon">
                    <i class="fas fa-hourglass-half"></i>
                </div>
                <div class="status-option-text">Прохожу</div>
            </div>
            
            <div class="status-option completed" data-status="COMPLETED">
                <div class="status-option-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="status-option-text">Пройдена</div>
            </div>
        </div>
        
        <div class="status-modal-actions">
            <button class="modal-btn modal-btn-cancel" onclick="closeStatusModal()">
                Отмена
            </button>
            <button class="modal-btn modal-btn-save" id="saveStatusBtn" onclick="saveGameStatus()">
                Сохранить
            </button>
        </div>
    </div>
</div>

<style>
    :root {
        --primary-dark: #0a0a0a;
        --secondary-dark: #1a1a1a;
        --accent-color: #00ff88;
        --accent-secondary: #ff6b35;
        --accent-purple: #a855f7;
        --text-color: #ffffff;
        --text-secondary: #a3a3a3;
        --text-muted: #6b7280;
        --background-gradient: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f1419 100%);
        --card-gradient: linear-gradient(145deg, rgba(255, 255, 255, 0.02) 0%, rgba(255, 255, 255, 0.08) 100%);
        --glow-green: 0 0 20px rgba(0, 255, 136, 0.3);
        --glow-orange: 0 0 20px rgba(255, 107, 53, 0.3);
        --glow-purple: 0 0 20px rgba(168, 85, 247, 0.3);
    }

    .profile-container {
        min-height: 100vh;
        background: var(--background-gradient);
        padding: 1rem;
        font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
        position: relative;
        overflow-x: hidden;
    }

    .profile-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 20% 80%, rgba(0, 255, 136, 0.05) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255, 107, 53, 0.05) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(168, 85, 247, 0.05) 0%, transparent 50%);
        pointer-events: none;
    }

    .dashboard-layout {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 2rem;
        max-width: 1600px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
    }

    .content-wrapper {
        background: var(--secondary-dark);
        padding: 2.5rem;
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 
            0 20px 50px rgba(0, 0, 0, 0.5),
            inset 0 1px 0 rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(15px);
        min-height: 20vh; /* Увеличиваем минимальную высоту */
    }

    .content-wrapper::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, 
            var(--accent-color) 0%, 
            var(--accent-secondary) 50%, 
            var(--accent-purple) 100%);
        opacity: 0.6;
    }

    .profile-header {
        text-align: center;
        margin-bottom: 3rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        position: relative;
    }

    .profile-avatar {
        font-size: 6rem;
        background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 1rem;
        filter: drop-shadow(0 4px 8px rgba(0, 255, 136, 0.3));
        animation: pulse-glow 3s ease-in-out infinite alternate;
    }

    @keyframes pulse-glow {
        0% { filter: drop-shadow(0 4px 8px rgba(0, 255, 136, 0.3)); }
        100% { filter: drop-shadow(0 8px 16px rgba(0, 255, 136, 0.5)); }
    }

    .profile-title {
        color: var(--text-color);
        font-size: 2.5rem;
        font-weight: 800;
        margin: 0;
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        letter-spacing: -0.02em;
        background: linear-gradient(45deg, #ffffff, #a3a3a3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .profile-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .stat-card {
        background: var(--card-gradient);
        border-radius: 16px;
        padding: 2rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.08);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.02), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: var(--glow-green);
        border-color: rgba(0, 255, 136, 0.3);
    }

    .stat-card:hover::before {
        opacity: 1;
    }

    .stat-card:nth-child(1):hover { box-shadow: var(--glow-green); }
    .stat-card:nth-child(2):hover { box-shadow: var(--glow-orange); }
    .stat-card:nth-child(3):hover { box-shadow: var(--glow-purple); }
    .stat-card:nth-child(4):hover { box-shadow: 0 0 20px rgba(6, 182, 212, 0.3); }

    .stat-icon {
        font-size: 2.5rem;
        background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        transition: all 0.3s ease;
    }

    .stat-card:nth-child(1) .stat-icon {
        background: linear-gradient(45deg, var(--accent-color), #00d9ff);
    }
    .stat-card:nth-child(2) .stat-icon {
        background: linear-gradient(45deg, var(--accent-secondary), #ff8c42);
    }
    .stat-card:nth-child(3) .stat-icon {
        background: linear-gradient(45deg, var(--accent-purple), #c084fc);
    }
    .stat-card:nth-child(4) .stat-icon {
        background: linear-gradient(45deg, #06b6d4, #0891b2);
    }

    .stat-info h3 {
        color: var(--text-secondary);
        font-size: 0.85rem;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .stat-value {
        color: var(--text-color);
        font-size: 2rem;
        font-weight: 800;
        margin: 0.5rem 0 0 0;
        min-width: 2ch;
        transition: all 0.3s ease;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        line-height: 1;
    }

    .search-sidebar {
        position: relative;
    }

    .search-title {
        color: var(--text-color);
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .search-title i {
        color: var(--accent-color);
    }

    .search-container {
        width: 100%;
    }

    .search-wrapper {
        position: relative;
        margin-bottom: 1rem;
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 1.2rem;
    }

    .search-input {
        width: 100%;
        padding: 1rem 1rem 1rem 3rem;
        background: var(--secondary-dark);
        border: 2px solid transparent;
        border-radius: 10px;
        color: var(--text-color);
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 15px rgba(0, 200, 255, 0.2);
    }

    .search-results {
        position: absolute;
        top: calc(100% + 5px);
        left: 0;
        right: 0;
        background: var(--secondary-dark);
        border-radius: 10px;
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .game-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }

    .game-item:last-child {
        border-bottom: none;
    }

    .game-item:hover {
        background: rgba(0, 200, 255, 0.1);
    }

    .game-image {
        width: 80px;
        height: 45px;
        object-fit: cover;
        border-radius: 5px;
        margin-right: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .game-info {
        flex-grow: 1;
        min-width: 0;
    }

    .game-title {
        margin: 0;
        color: var(--text-color);
        font-size: 0.9rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .game-meta {
        color: var(--text-secondary);
        font-size: 0.8rem;
        margin-top: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .metacritic-score {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        border-radius: 5px;
        font-weight: bold;
        font-size: 0.8rem;
        min-width: 32px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .add-game-btn {
        background: none;
        border: none;
        color: var(--accent-color);
        padding: 0.5rem;
        margin-left: 0.5rem;
        transition: all 0.3s ease;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .add-game-btn:hover {
        background: rgba(0, 200, 255, 0.1);
        transform: scale(1.1);
    }

    /* Стилизация скроллбара */
    .search-results::-webkit-scrollbar {
        width: 8px;
    }

    .search-results::-webkit-scrollbar-track {
        background: var(--primary-dark);
        border-radius: 4px;
    }

    .search-results::-webkit-scrollbar-thumb {
        background: var(--accent-color);
        border-radius: 4px;
    }

    .search-results::-webkit-scrollbar-thumb:hover {
        background: #00a0ff;
    }

    /* Анимация появления */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .content-wrapper {
        animation: fadeInUp 0.6s ease-out;
    }

    .user-games-section {
        margin-top: 2rem;
    }
    
    .user-games-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .user-games-title {
        color: var(--text-color);
        font-size: 2rem;
        margin: 0;
        font-weight: 800;
        letter-spacing: -0.02em;
        background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        position: relative;
    }
    
    .user-games-title::after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 0;
        width: 60px;
        height: 3px;
        background: linear-gradient(90deg, var(--accent-color), var(--accent-secondary));
        border-radius: 2px;
    }

    .user-games-search {
        flex: 1;
        max-width: 400px;
        min-width: 280px;
    }

    .user-search-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .user-search-input {
        width: 100%;
        padding: 0.875rem 2.5rem 0.875rem 3rem;
        background: rgba(255, 255, 255, 0.06);
        border: 2px solid rgba(255, 255, 255, 0.12);
        border-radius: 14px;
        color: var(--text-color);
        font-size: 0.95rem;
        font-weight: 500;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        box-shadow: 
            inset 0 2px 4px rgba(0, 0, 0, 0.2),
            0 1px 0 rgba(255, 255, 255, 0.08);
    }

    .user-search-input::placeholder {
        color: var(--text-muted);
        font-weight: 400;
    }

    .user-search-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 
            0 0 0 3px rgba(0, 255, 136, 0.15),
            inset 0 2px 4px rgba(0, 0, 0, 0.1),
            0 1px 0 rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.08);
    }

    .user-search-icon {
        position: absolute;
        left: 1rem;
        color: var(--accent-color);
        font-size: 1rem;
        opacity: 0.8;
        transition: all 0.3s ease;
        pointer-events: none;
    }

    .user-search-wrapper:focus-within .user-search-icon {
        opacity: 1;
        transform: scale(1.1);
        filter: drop-shadow(0 0 6px rgba(0, 255, 136, 0.4));
    }

    .user-search-clear {
        position: absolute;
        right: 0.75rem;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        opacity: 0;
        transform: scale(0.8);
        font-size: 0.85rem;
    }

    .user-search-clear.show {
        opacity: 1;
        transform: scale(1);
    }

    .user-search-clear:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-color);
    }
    
    .user-games-list {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 2rem;
    }
    
    .user-game-card {
        background: var(--card-gradient);
        border-radius: 24px;
        box-shadow: 
            0 15px 40px rgba(0, 0, 0, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
        padding: 0;
        display: flex;
        flex-direction: column;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        min-height: 460px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        overflow: hidden;
        backdrop-filter: blur(20px);
    }
    
    .user-game-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.02), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .user-game-card:hover {
        transform: translateY(-12px) scale(1.02);
        box-shadow: 
            0 20px 50px rgba(0, 0, 0, 0.4),
            var(--glow-green),
            inset 0 1px 0 rgba(255, 255, 255, 0.15);
        border-color: rgba(0, 255, 136, 0.3);
    }
    
    .user-game-card:hover::before {
        opacity: 1;
    }
    
    .user-game-img {
        width: 100%;
        height: 240px;
        object-fit: cover;
        border-radius: 24px 24px 0 0;
        transition: all 0.3s ease;
        position: relative;
        cursor: pointer;
    }
    
    .user-game-card:hover .user-game-img {
        transform: scale(1.05);
        filter: brightness(1.1);
    }
    
    .user-game-content {
        padding: 2rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }
    
    .user-game-title {
        color: var(--text-color);
        font-size: 1.5rem;
        font-weight: 800;
        margin: 0;
        line-height: 1.2;
        cursor: pointer;
        transition: all 0.3s ease;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        word-break: break-word;
        hyphens: auto;
    }
    
    .user-game-title:hover {
        color: var(--accent-color);
        text-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
        transform: translateY(-2px);
    }
    
    .user-game-status {
        font-size: 0.9rem;
        font-weight: 700;
        padding: 0.75rem 1.25rem;
        border-radius: 16px;
        display: inline-block;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        cursor: pointer;
        transition: all 0.3s ease;
        align-self: flex-start;
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
    }
    
    .user-game-status::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }
    
    .user-game-status:hover {
        transform: scale(1.08) translateY(-2px);
        border-color: rgba(255, 255, 255, 0.3);
    }
    
    .user-game-status:hover::before {
        left: 100%;
    }
    
    .user-game-status.completed {
        background: linear-gradient(45deg, #10b981, #059669);
        color: #ffffff;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .user-game-status.playing {
        background: linear-gradient(45deg, #f59e0b, #d97706);
        color: #ffffff;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    }
    
    .user-game-status.plan {
        background: linear-gradient(45deg, #6b7280, #4b5563);
        color: #ffffff;
        box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
    }
    
    .user-game-rating {
        color: var(--text-secondary);
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-top: auto;
        padding: 0.75rem 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        transition: all 0.3s ease;
    }
    
    .user-game-rating:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.15);
    }
    
    .user-game-rating i {
        color: #fbbf24;
        font-size: 1.2rem;
        filter: drop-shadow(0 0 5px rgba(251, 191, 36, 0.4));
    }

    /* Уведомления */
    .notification {
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: var(--secondary-dark);
        border-radius: 15px;
        padding: 1rem 1.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        transform: translateX(120%);
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        border-left: 4px solid var(--accent-color);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        gap: 1rem;
        min-width: 300px;
        max-width: 400px;
    }

    .notification.show {
        transform: translateX(0);
    }

    .notification.success {
        border-left-color: #2ecc71;
    }

    .notification.error {
        border-left-color: #e74c3c;
    }

    .notification.info {
        border-left-color: #3498db;
    }

    .notification-icon {
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .notification.success .notification-icon {
        color: #2ecc71;
    }

    .notification.error .notification-icon {
        color: #e74c3c;
    }

    .notification.info .notification-icon {
        color: #3498db;
    }

    .notification-content {
        flex-grow: 1;
    }

    .notification-title {
        font-weight: 600;
        color: var(--text-color);
        margin: 0 0 0.25rem 0;
        font-size: 1rem;
    }

    .notification-message {
        color: var(--text-secondary);
        margin: 0;
        font-size: 0.9rem;
    }

    .notification-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 50%;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    .notification-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-color);
    }

    /* Модальное окно для изменения статуса */
    .status-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 10001;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
    }

    .status-modal.show {
        display: flex;
    }

    .status-modal-content {
        background: var(--card-gradient);
        border-radius: 24px;
        padding: 2.5rem;
        max-width: 450px;
        width: 90%;
        box-shadow: 
            0 25px 60px rgba(0, 0, 0, 0.6),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.08);
        transform: scale(0.8) translateY(50px);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        backdrop-filter: blur(20px);
        position: relative;
        overflow: hidden;
    }

    .status-modal-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, 
            var(--accent-color) 0%, 
            var(--accent-secondary) 50%, 
            var(--accent-purple) 100%);
        opacity: 0.8;
    }

    .status-modal.show .status-modal-content {
        transform: scale(1) translateY(0);
        opacity: 1;
    }

    .status-modal-header {
        text-align: center;
        margin-bottom: 2rem;
        position: relative;
    }

    .status-modal-title {
        color: var(--text-color);
        font-size: 1.8rem;
        font-weight: 800;
        margin: 0 0 0.75rem 0;
        background: linear-gradient(45deg, var(--text-color), var(--text-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .status-modal-game-name {
        color: var(--accent-color);
        font-size: 1.1rem;
        margin: 0;
        font-weight: 600;
        text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
    }

    .status-options {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        margin-bottom: 2rem;
    }

    .status-option {
        background: rgba(255, 255, 255, 0.03);
        border: 2px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 1.25rem 1.5rem;
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 1.25rem;
        position: relative;
        overflow: hidden;
    }

    .status-option::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.02), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .status-option:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .status-option:hover::before {
        opacity: 1;
    }

    .status-option.plan:hover {
        border-color: rgba(107, 114, 128, 0.5);
        box-shadow: 0 8px 25px rgba(107, 114, 128, 0.2);
    }

    .status-option.playing:hover {
        border-color: rgba(245, 158, 11, 0.5);
        box-shadow: 0 8px 25px rgba(245, 158, 11, 0.2);
    }

    .status-option.completed:hover {
        border-color: rgba(16, 185, 129, 0.5);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2);
    }

    .status-option.selected {
        background: rgba(0, 255, 136, 0.1);
        border-color: var(--accent-color);
        box-shadow: var(--glow-green);
    }

    .status-option-icon {
        font-size: 1.5rem;
        width: 28px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .status-option.plan .status-option-icon {
        color: #6b7280;
    }

    .status-option.playing .status-option-icon {
        color: #f59e0b;
    }

    .status-option.completed .status-option-icon {
        color: #10b981;
    }

    .status-option:hover .status-option-icon {
        transform: scale(1.2);
    }

    .status-option-text {
        flex-grow: 1;
        font-weight: 600;
        font-size: 1.05rem;
    }

    .status-modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        margin-top: 1rem;
    }

    .modal-btn {
        padding: 1rem 2rem;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 0.95rem;
        position: relative;
        overflow: hidden;
    }

    .modal-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transform: translateX(-100%);
        transition: transform 0.6s ease;
    }

    .modal-btn:hover::before {
        transform: translateX(100%);
    }

    .modal-btn-cancel {
        background: transparent;
        color: var(--text-secondary);
        border: 2px solid rgba(255, 255, 255, 0.15);
    }

    .modal-btn-cancel:hover {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-color);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .modal-btn-save {
        background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
        color: white;
        border: 2px solid transparent;
        box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
    }

    .modal-btn-save:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        border-color: rgba(255, 255, 255, 0.2);
    }

    .modal-btn-save:disabled {
        background: linear-gradient(45deg, #4a4a4a, #3a3a3a);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        border-color: transparent;
    }

    .game-delete-btn {
        background: linear-gradient(45deg, #ef4444, #dc2626);
        color: white;
        border: 2px solid transparent;
        border-radius: 16px;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
        font-weight: 700;
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        position: relative;
        overflow: hidden;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .game-delete-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }
    
    .game-delete-btn:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 12px 30px rgba(239, 68, 68, 0.6);
        border-color: rgba(255, 255, 255, 0.3);
    }
    
    .game-delete-btn:hover::before {
        left: 100%;
    }
    
    .game-delete-btn:active {
        transform: translateY(-1px) scale(1.02);
    }
    
    .game-delete-btn i {
        margin-right: 0.5rem;
    }

    .search-title {
        color: var(--text-color);
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .search-wrapper {
        position: relative;
        margin-bottom: 1rem;
    }

    .search-input {
        width: 100%;
        padding: 1.25rem 1.25rem 1.25rem 3.5rem;
        background: rgba(255, 255, 255, 0.08);
        border: 2px solid rgba(255, 255, 255, 0.15);
        border-radius: 16px;
        color: var(--text-color);
        font-size: 1.05rem;
        font-weight: 500;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        box-shadow: 
            inset 0 2px 4px rgba(0, 0, 0, 0.2),
            0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .search-input::placeholder {
        color: var(--text-muted);
        font-weight: 400;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 
            0 0 0 3px rgba(0, 255, 136, 0.15),
            inset 0 2px 4px rgba(0, 0, 0, 0.1),
            0 1px 0 rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.12);
    }

    .search-icon {
        position: absolute;
        left: 1.25rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--accent-color);
        font-size: 1.2rem;
        opacity: 0.8;
        transition: all 0.3s ease;
    }

    .search-wrapper:focus-within .search-icon {
        opacity: 1;
        transform: translateY(-50%) scale(1.1);
        filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.4));
    }

    .search-results {
        background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
        border-radius: 16px;
        border: 2px solid rgba(0, 255, 136, 0.3);
        backdrop-filter: blur(20px);
        max-height: 80vh;
        min-height: 600px;
        height: auto;
        overflow-y: auto;
        display: none;
        position: absolute;
        top: 100%;
        width: 500px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10000;
        box-shadow: 
            0 20px 40px rgba(0, 0, 0, 0.8),
            0 0 0 1px rgba(255, 255, 255, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.15);
        margin-top: 0.5rem;
    }

    /* Кастомный скроллбар для результатов поиска */
    .search-results::-webkit-scrollbar {
        width: 8px;
    }

    .search-results::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }

    .search-results::-webkit-scrollbar-thumb {
        background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .search-results::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(45deg, var(--accent-secondary), var(--accent-color));
        box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
    }

    .game-item {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        padding: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        position: relative;
        min-height: 110px;
        background: rgba(255, 255, 255, 0.02);
        margin: 0.5rem;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .game-item:hover {
        background: rgba(0, 255, 136, 0.12);
        border-color: rgba(0, 255, 136, 0.4);
        transform: translateX(8px) scale(1.02);
        box-shadow: 
            0 8px 25px rgba(0, 255, 136, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .game-item:last-child {
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    }

    .game-image {
        width: 100px;
        height: 60px;
        object-fit: cover;
        border-radius: 12px;
        flex-shrink: 0;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        border: 2px solid rgba(255, 255, 255, 0.15);
        transition: all 0.3s ease;
    }

    .game-item:hover .game-image {
        transform: scale(1.05);
        box-shadow: 0 12px 30px rgba(0, 255, 136, 0.3);
        border-color: rgba(0, 255, 136, 0.5);
    }

    .game-info {
        flex-grow: 1;
        min-width: 0;
    }

    .game-title {
        color: var(--text-color);
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0 0 0.5rem 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        line-height: 1.3;
        cursor: pointer;
        transition: all 0.3s ease;
        background: linear-gradient(45deg, var(--text-color), rgba(255, 255, 255, 0.8));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .game-title:hover {
        background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
        transform: translateX(5px);
    }

    .game-meta {
        color: var(--text-secondary);
        font-size: 0.95rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-weight: 500;
        opacity: 0.85;
        line-height: 1.4;
        padding: 0.25rem 0;
        transition: all 0.3s ease;
    }

    .game-item:hover .game-meta {
        color: rgba(255, 255, 255, 0.9);
        opacity: 1;
    }

    .add-game-btn {
        background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.25);
        border-radius: 14px;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        flex-shrink: 0;
        font-size: 1.3rem;
        font-weight: 700;
        box-shadow: 
            0 6px 20px rgba(0, 255, 136, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.2);
        position: relative;
        overflow: hidden;
    }

    .add-game-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .add-game-btn:hover {
        transform: scale(1.15) rotate(90deg);
        box-shadow: 
            0 10px 35px rgba(0, 255, 136, 0.6),
            0 0 0 3px rgba(0, 255, 136, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
    }

    .add-game-btn:hover::before {
        left: 100%;
    }

    .add-game-btn:active {
        transform: scale(1.05) rotate(90deg);
    }

    /* Адаптивность */
    @media (max-width: 1600px) {
        .user-games-list {
            grid-template-columns: repeat(3, 1fr);
            gap: 1.8rem;
        }
    }

    @media (max-width: 1400px) {
        .dashboard-layout {
            grid-template-columns: 1fr 350px;
        }
        
        .user-games-list {
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
        }
    }

    @media (max-width: 1200px) {
        .dashboard-layout {
            grid-template-columns: 1fr 320px;
        }
        
        .user-games-list {
            grid-template-columns: repeat(2, 1fr);
            gap: 1.8rem;
        }
    }

    @media (max-width: 991px) {
        .dashboard-layout {
            grid-template-columns: 1fr;
        }

        .search-sidebar {
            order: -1;
        }

        .profile-container {
            padding: 1rem;
        }
        
        .user-games-list {
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        
        .user-game-card {
            min-height: 400px;
        }
        
        .user-game-img {
            height: 200px;
        }
    }

    .notification {
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: var(--card-gradient);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 1.5rem;
        min-width: 320px;
        max-width: 400px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(20px);
        z-index: 10000;
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }

    .notification.show {
        transform: translateX(0);
        opacity: 1;
    }

    .notification.success {
        border-left: 4px solid var(--accent-color);
    }

    .notification.error {
        border-left: 4px solid #ef4444;
    }

    .notification.info {
        border-left-color: #3498db;
    }

    .notification-icon {
        flex-shrink: 0;
        font-size: 1.5rem;
    }

    .notification.success .notification-icon {
        color: var(--accent-color);
    }

    .notification.error .notification-icon {
        color: #ef4444;
    }

    .notification.info .notification-icon {
        color: #3498db;
    }

    .notification-content {
        flex-grow: 1;
    }

    .notification-title {
        color: var(--text-color);
        font-weight: 700;
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }

    .notification-message {
        color: var(--text-secondary);
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .notification-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    .notification-close:hover {
        color: var(--text-color);
        background: rgba(255, 255, 255, 0.1);
    }

    @media (max-width: 768px) {
        .profile-stats {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .user-games-list {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        .user-game-card {
            min-height: 380px;
        }
        
        .user-game-img {
            height: 200px;
        }
        
        .user-game-content {
            padding: 1.5rem;
        }
        
        .user-game-title {
            font-size: 1.3rem;
        }
    }

    @media (max-width: 480px) {
        .profile-stats {
            grid-template-columns: 1fr;
        }
        
        .user-games-list {
            grid-template-columns: 1fr;
            gap: 1.25rem;
        }
        
        .user-game-card {
            min-height: 350px;
        }
        
        .user-game-img {
            height: 180px;
        }
        
        .user-game-content {
            padding: 1.25rem;
            gap: 1rem;
        }
        
        .user-game-title {
            font-size: 1.2rem;
        }
        
        .game-delete-btn {
            padding: 0.75rem 1.25rem;
            font-size: 0.9rem;
        }

        .notification {
            top: 1rem;
            right: 1rem;
            left: 1rem;
            min-width: auto;
            max-width: none;
        }
        
        .profile-title {
            font-size: 2rem;
        }
        
        .user-games-title {
            font-size: 1.5rem;
        }
    }

    /* Стили для рекомендаций */
    .recommendations-section {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .recommendations-title {
        color: var(--text-color);
        font-size: 1.5rem;
        margin: 0 0 1.5rem 0;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .recommendations-title i {
        color: var(--accent-secondary);
        font-size: 1.3rem;
    }

    .recommendations-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .recommendations-loading {
        grid-column: 1 / -1;
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }

    .recommendations-loading i {
        font-size: 2rem;
        color: var(--accent-color);
        margin-bottom: 1rem;
        display: block;
    }

    .recommendation-card {
        background: var(--card-gradient);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.08);
        cursor: pointer;
        position: relative;
    }

    .recommendation-card:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 
            0 10px 25px rgba(0, 0, 0, 0.3),
            var(--glow-green);
        border-color: rgba(0, 255, 136, 0.3);
    }

    .recommendation-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
        transition: all 0.3s ease;
    }

    .recommendation-card:hover .recommendation-image {
        transform: scale(1.05);
        filter: brightness(1.1);
    }

    .recommendation-content {
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .recommendation-title {
        color: var(--text-color);
        font-size: 0.9rem;
        font-weight: 600;
        margin: 0;
        line-height: 1.2;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .recommendation-meta {
        color: var(--text-secondary);
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .recommendation-rating {
        background: var(--accent-color);
        color: var(--primary-dark);
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.7rem;
    }

    .recommendation-add-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: rgba(0, 0, 0, 0.7);
        border: none;
        color: var(--accent-color);
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        opacity: 0;
        backdrop-filter: blur(10px);
    }

    .recommendation-card:hover .recommendation-add-btn {
        opacity: 1;
    }

    .recommendation-add-btn:hover {
        background: var(--accent-color);
        color: var(--primary-dark);
        transform: scale(1.1);
    }

    .recommendations-empty {
        grid-column: 1 / -1;
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }

    .recommendations-empty i {
        font-size: 2rem;
        color: var(--accent-secondary);
        margin-bottom: 1rem;
        display: block;
        opacity: 0.5;
    }

    /* Адаптивность для рекомендаций */
    @media (max-width: 1200px) {
        .recommendations-container {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
let searchTimeout;

function getJWTToken() {
    const token = localStorage.getItem('jwt_token');
    if (!token) {
        console.warn('JWT токен не найден. Проверьте авторизацию.');
    }
    return token;
}

const statusMap = {
    'PLAN_TO_PLAY': {text: 'Планирую играть', class: 'plan'},
    'PLAYING': {text: 'Играю', class: 'playing'},
    'COMPLETED': {text: 'Завершено', class: 'completed'},
};

function renderUserGames(games) {
    const container = document.getElementById('userGamesList');
    container.innerHTML = '';
    if (!games.length) {
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; font-size: 1.4rem; margin: 4rem 0; font-weight: 600;">У вас пока нет игр в коллекции 🎮</p>';
        return;
    }
    games.forEach(obj => {
        const game = obj.game;
        const status = statusMap[obj.status] || {text: obj.status, class: ''};
        const div = document.createElement('div');
        div.className = 'user-game-card';
        div.setAttribute('data-game-id', game.id || game.slug);
        div.innerHTML = `
            <img class="user-game-img" src="${game.logo}" alt="${game.name}" onclick="navigateToGamePage('${game.slug}')" title="Перейти к описанию игры">
            <div class="user-game-content">
                <h3 class="user-game-title" data-slug="${game.slug}" title="Перейти к описанию игры">${game.name}</h3>
                <span class="user-game-status ${status.class}" onclick="openStatusModal('${game.slug}', '${game.name}', '${obj.status}')" title="Изменить статус игры">
                    ${status.text}
                </span>
                ${obj.user_raiting ? `<div class="user-game-rating"><i class="fas fa-star"></i> Оценка: ${obj.user_raiting}/10</div>` : '<div class="user-game-rating"><i class="fas fa-star-o"></i> Не оценена</div>'}
                <button class="game-delete-btn" onclick="deleteGameFromCollection('${game.slug}')" title="Удалить из коллекции">
                    <i class="fas fa-trash"></i> Удалить
                </button>
            </div>
        `;
        container.appendChild(div);
    });
    
    // Добавляем обработчики кликов для названий игр
    container.querySelectorAll('.user-game-title').forEach(title => {
        title.addEventListener('click', function() {
            const slug = this.getAttribute('data-slug');
            navigateToGamePage(slug);
        });
    });
}

// Переменные для поиска пользовательских игр
let allUserGames = [];
let filteredUserGames = [];

// Функция поиска среди пользовательских игр
function filterUserGames(searchQuery) {
    if (!searchQuery.trim()) {
        filteredUserGames = [...allUserGames];
    } else {
        const query = searchQuery.toLowerCase().trim();
        filteredUserGames = allUserGames.filter(gameObj => 
            gameObj.game.name.toLowerCase().includes(query)
        );
    }
    renderUserGames(filteredUserGames);
}

// Функция для очистки поиска пользовательских игр
function clearUserGamesSearch() {
    const searchInput = document.getElementById('userGamesSearch');
    const clearBtn = document.getElementById('clearUserSearch');
    
    searchInput.value = '';
    clearBtn.classList.remove('show');
    searchInput.focus();
    
    // Показываем все игры
    filterUserGames('');
}

// Инициализация поиска пользовательских игр
function initUserGamesSearch() {
    const searchInput = document.getElementById('userGamesSearch');
    const clearBtn = document.getElementById('clearUserSearch');
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            // Показать/скрыть кнопку очистки
            if (query.length > 0) {
                clearBtn.classList.add('show');
            } else {
                clearBtn.classList.remove('show');
            }
            
            // Динамический поиск
            filterUserGames(query);
        });
    }
}

window.addEventListener('DOMContentLoaded', function() {
    // Сохраняем access токен в localStorage, если он передан из views
    {% if access_token %}
        localStorage.setItem('jwt_token', '{{ access_token }}');
    {% endif %}
    
    const userGames = {{ user_games_json|safe }};
    allUserGames = [...userGames];
    filteredUserGames = [...userGames];
    renderUserGames(userGames);
    
    // Инициализируем поиск пользовательских игр
    initUserGamesSearch();
    
    // Загружаем рекомендации
    fetchRecommendations();
    
    // Анимация счетчиков статистики
    animateCounters();
});

// Функция анимации счетчиков
function animateCounters() {
    const counters = document.querySelectorAll('.stat-value');
    
    counters.forEach(counter => {
        const target = parseInt(counter.textContent);
        counter.textContent = '0';
        
        const increment = target / 50;
        let current = 0;
        
        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                counter.textContent = target;
                clearInterval(timer);
            } else {
                counter.textContent = Math.floor(current);
            }
        }, 20);
    });
}

// Функция для показа уведомлений
function showNotification(type, title, message) {
    // Удаляем существующее уведомление, если есть
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }

    // Создаем новое уведомление
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    const iconClass = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
    
    notification.innerHTML = `
        <div class="notification-icon">
            <i class="${iconClass}"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title">${title}</div>
            <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close" onclick="hideNotification(this)">
            <i class="fas fa-times"></i>
        </button>
    `;

    document.body.appendChild(notification);

    // Показываем уведомление с анимацией
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);

    // Автоматически скрываем через 5 секунд
    setTimeout(() => {
        hideNotification(notification);
    }, 5000);
}

function hideNotification(element) {
    const notification = element.closest ? element.closest('.notification') : element;
    notification.classList.remove('show');
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 400);
}

document.getElementById('gameSearch').addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    const searchQuery = e.target.value.trim();
    const resultsContainer = document.getElementById('searchResults');
    
    if (searchQuery.length > 0) {
        resultsContainer.style.display = 'block';
        searchTimeout = setTimeout(() => {
            fetchGames(searchQuery);
        }, 300);
    } else {
        resultsContainer.style.display = 'none';
    }
});

document.addEventListener('click', function(e) {
    const searchContainer = document.querySelector('.search-container');
    const resultsContainer = document.getElementById('searchResults');
    if (!searchContainer.contains(e.target)) {
        resultsContainer.style.display = 'none';
    }
});

function fetchGames(query) {
    const resultsContainer = document.getElementById('searchResults');
    const token = getJWTToken();
    
    // Проверяем наличие токена
    if (!token) {
        resultsContainer.innerHTML = `
            <div style="padding: 2rem; text-align: center; color: #ef4444;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                <p style="margin: 0; font-size: 1.1rem; font-weight: 700;">Ошибка авторизации</p>
                <p style="margin: 0.5rem 0 0; font-size: 0.9rem; opacity: 0.8; line-height: 1.4;">Необходимо перезайти в аккаунт.<br>Обновите страницу и попробуйте снова.</p>
            </div>
        `;
        return;
    }
    
    // Показываем индикатор загрузки
    resultsContainer.innerHTML = `
        <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--accent-color); margin-bottom: 1rem; display: block;"></i>
            <p style="margin: 0; font-size: 1.1rem; font-weight: 600;">Поиск игр...</p>
            <p style="margin: 0.5rem 0 0; font-size: 0.9rem; opacity: 0.7;">Пожалуйста, подождите</p>
        </div>
    `;
    
    fetch(`/api/gameList/${encodeURIComponent(query)}/`, {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
        .then(response => response.json())
        .then(games => {
            resultsContainer.innerHTML = '';
            
                         if (games.length === 0) {
                 resultsContainer.innerHTML = `
                     <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                         <i class="fas fa-search" style="font-size: 2rem; color: var(--accent-color); opacity: 0.5; margin-bottom: 1rem; display: block;"></i>
                         <p style="margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--text-color);">Игры не найдены</p>
                         <p style="margin: 0.5rem 0 0; font-size: 0.9rem; opacity: 0.8; line-height: 1.4;">Попробуйте изменить поисковый запрос</p>
                     </div>
                 `;
                 return;
             }
            
            games.forEach(game => {
                const gameElement = createGameElement(game);
                resultsContainer.appendChild(gameElement);
            });
        })
                 .catch(error => {
             console.error('Error:', error);
             resultsContainer.innerHTML = `
                 <div style="padding: 2rem; text-align: center; color: #ef4444;">
                     <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                     <p style="margin: 0; font-size: 1.1rem; font-weight: 700;">Ошибка поиска</p>
                     <p style="margin: 0.5rem 0 0; font-size: 0.9rem; opacity: 0.8; line-height: 1.4;">Не удалось выполнить поиск.<br>Попробуйте еще раз позже.</p>
                 </div>
             `;
         });
}

function createGameElement(game) {
    const gameItem = document.createElement('div');
    gameItem.className = 'game-item';
    gameItem.style.cursor = 'pointer';
    gameItem.addEventListener('click', function(e) {
        // Если клик не по кнопке добавления, то переходим к игре
        if (!e.target.closest('.add-game-btn')) {
            navigateToGamePage(game.slug);
        }
    });
    
    const image = document.createElement('img');
    image.className = 'game-image';
    image.src = game.background_image;
    image.alt = game.name;
    
    const info = document.createElement('div');
    info.className = 'game-info';
    
    const titleRow = document.createElement('div');
    titleRow.style.display = 'flex';
    titleRow.style.justifyContent = 'space-between';
    titleRow.style.alignItems = 'flex-start';
    titleRow.style.width = '100%';
    
    const titleContainer = document.createElement('div');
    titleContainer.style.flex = '1';
    titleContainer.style.minWidth = '0';
    
    const title = document.createElement('h3');
    title.className = 'game-title';
    title.textContent = game.name;
    
    const meta = document.createElement('div');
    meta.className = 'game-meta';
    let metaText = '';
    if (game.genres && game.genres.length > 0) {
        metaText = game.genres.map(g => g.name).join(', ');
    }
    if (game.metacritic) {
        metaText += ` • ${game.metacritic}/100`;
    }
    meta.textContent = metaText;
    
    const addButton = document.createElement('button');
    addButton.className = 'add-game-btn';
    addButton.innerHTML = '<i class="fas fa-plus"></i>';
    addButton.title = 'Добавить в коллекцию';
    addButton.addEventListener('click', function(e) {
        e.stopPropagation();
        addGameToProfile(game.slug);
    });
    
    titleContainer.appendChild(title);
    titleContainer.appendChild(meta);
    titleRow.appendChild(titleContainer);
    titleRow.appendChild(addButton);
    info.appendChild(titleRow);
    gameItem.appendChild(image);
    gameItem.appendChild(info);
    
    return gameItem;
}

function addGameToProfile(slug) {
    const token = getJWTToken();
    
    if (!token) {
        showNotification('error', 'Ошибка авторизации', 'Необходимо перезайти в аккаунт');
        return;
    }
    
    fetch(`/api/game/${encodeURIComponent(slug)}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({addGame: true})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('success', 'Успешно!', 'Игра добавлена в коллекцию');
            
            // Обновляем счетчики при добавлении игры
            updateStatsAfterGameAddition();
            
            fetchUserGames();
        } else {
            showNotification('error', 'Ошибка', 'Не удалось добавить игру в коллекцию');
        }
    })
    .catch(error => {
        console.error('Ошибка при добавлении игры:', error);
        showNotification('error', 'Ошибка', 'Не удалось добавить игру в коллекцию');
    });
}

function fetchUserGames() {
    const token = getJWTToken();
    
    if (!token) {
        console.error('Невозможно загрузить игры пользователя: отсутствует токен авторизации');
        return;
    }
    
    fetch('/api/user/games/', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => response.json())
    .then(games => {
        // Обновляем массивы для поиска
        allUserGames = [...games];
        filteredUserGames = [...games];
        
        // Проверяем, есть ли активный поиск
        const searchInput = document.getElementById('userGamesSearch');
        if (searchInput && searchInput.value.trim()) {
            filterUserGames(searchInput.value.trim());
        } else {
            renderUserGames(games);
        }
        
        updateStatistics(games);
    })
    .catch(error => console.error('Ошибка при получении игр пользователя:', error));
}

// Функция обновления статистики
function updateStatistics(games) {
    const totalGames = games.length;
    const completedGames = games.filter(game => game.status === 'COMPLETED').length;
    const playingGames = games.filter(game => game.status === 'PLAYING').length;
    const planGames = games.filter(game => game.status === 'PLAN_TO_PLAY').length;
    
    // Обновляем значения с анимацией
    updateCounterValue(document.querySelector('.stat-card:nth-child(1) .stat-value'), totalGames);
    updateCounterValue(document.querySelector('.stat-card:nth-child(2) .stat-value'), completedGames);
    updateCounterValue(document.querySelector('.stat-card:nth-child(3) .stat-value'), playingGames);
    updateCounterValue(document.querySelector('.stat-card:nth-child(4) .stat-value'), planGames);
}

// Функция анимации обновления счетчика
function updateCounterValue(element, newValue) {
    const currentValue = parseInt(element.textContent);
    if (currentValue === newValue) return;
    
    const increment = (newValue - currentValue) / 20;
    let current = currentValue;
    
    const timer = setInterval(() => {
        current += increment;
        if ((increment > 0 && current >= newValue) || (increment < 0 && current <= newValue)) {
            element.textContent = newValue;
            clearInterval(timer);
        } else {
            element.textContent = Math.floor(current);
        }
    }, 20);
}

function getMetacriticColor(score) {
    if (score >= 75) return '#2ecc71';
    if (score >= 50) return '#f1c40f';
    return '#e74c3c';
}

function deleteGameFromCollection(slug) {
    // Получаем статус удаляемой игры для обновления счетчиков
    const gameStatus = getCurrentGameStatus(slug);
    
    fetch('/api/user/games/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getJWTToken()
        },
        body: JSON.stringify({slug: slug})
    })
    .then(response => {
        if (response.status === 204) {
            showNotification('success', 'Успешно!', 'Игра удалена из коллекции');
            
            // Обновляем счетчики при удалении игры
            updateStatsAfterGameDeletion(gameStatus);
            
            // Успешно удалено - удаляем элемент из DOM
            const gameCards = document.querySelectorAll('.user-game-card');
            gameCards.forEach(card => {
                const titleElement = card.querySelector('.user-game-title');
                if (titleElement && titleElement.getAttribute('data-slug') === slug) {
                    card.style.transition = 'all 0.4s ease';
                    card.style.transform = 'scale(0.8) translateY(20px)';
                    card.style.opacity = '0';
                    setTimeout(() => {
                        card.remove();
                        // Проверяем, есть ли еще игры
                        const remainingCards = document.querySelectorAll('.user-game-card');
                        if (remainingCards.length === 0) {
                            document.getElementById('userGamesList').innerHTML = '<p style="color: var(--text-secondary); text-align: center; font-size: 1.4rem; margin: 4rem 0; font-weight: 600;">У вас пока нет игр в коллекции 🎮</p>';
                        }
                    }, 400);
                }
            });
        } else if (response.status === 404) {
            showNotification('error', 'Ошибка', 'Игра не найдена в вашей коллекции');
        } else {
            showNotification('error', 'Ошибка', 'Не удалось удалить игру из коллекции');
        }
    })
    .catch(error => {
        console.error('Ошибка при удалении игры:', error);
        showNotification('error', 'Ошибка', 'Не удалось удалить игру из коллекции');
    });
}

// Обновление счетчиков при добавлении игры
function updateStatsAfterGameAddition() {
    const counters = {
        total: document.querySelector('.stat-card:nth-child(1) .stat-value'),
        plan: document.querySelector('.stat-card:nth-child(4) .stat-value')
    };
    
    // Увеличиваем общий счетчик
    const totalValue = parseInt(counters.total.textContent);
    updateCounterValue(counters.total, totalValue + 1);
    
    // Увеличиваем счетчик "Планирую пройти" (по умолчанию новые игры добавляются с этим статусом)
    const planValue = parseInt(counters.plan.textContent);
    updateCounterValue(counters.plan, planValue + 1);
}

// Обновление счетчиков при удалении игры
function updateStatsAfterGameDeletion(deletedGameStatus) {
    const counters = {
        total: document.querySelector('.stat-card:nth-child(1) .stat-value'),
        completed: document.querySelector('.stat-card:nth-child(2) .stat-value'),
        playing: document.querySelector('.stat-card:nth-child(3) .stat-value'),
        plan: document.querySelector('.stat-card:nth-child(4) .stat-value')
    };
    
    // Уменьшаем общий счетчик
    const totalValue = parseInt(counters.total.textContent);
    updateCounterValue(counters.total, totalValue - 1);
    
    // Уменьшаем соответствующий счетчик статуса
    if (deletedGameStatus === 'COMPLETED') {
        const currentValue = parseInt(counters.completed.textContent);
        updateCounterValue(counters.completed, currentValue - 1);
    } else if (deletedGameStatus === 'PLAYING') {
        const currentValue = parseInt(counters.playing.textContent);
        updateCounterValue(counters.playing, currentValue - 1);
    } else if (deletedGameStatus === 'PLAN_TO_PLAY') {
        const currentValue = parseInt(counters.plan.textContent);
        updateCounterValue(counters.plan, currentValue - 1);
    }
}

// Переменные для модального окна статуса
let currentGameSlug = null;
let selectedStatus = null;

// Открытие модального окна для изменения статуса
function openStatusModal(gameSlug, gameName, currentStatus) {
    currentGameSlug = gameSlug;
    selectedStatus = currentStatus;
    
    document.getElementById('modalGameName').textContent = gameName;
    
    // Сброс выбранных опций
    document.querySelectorAll('.status-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Выделяем текущий статус
    const currentOption = document.querySelector(`[data-status="${currentStatus}"]`);
    if (currentOption) {
        currentOption.classList.add('selected');
    }
    
    // Показываем модальное окно
    const modal = document.getElementById('statusModal');
    modal.classList.add('show');
    
    // Добавляем обработчик клика на фон для закрытия
    modal.onclick = function(e) {
        if (e.target === modal) {
            closeStatusModal();
        }
    };
}

// Закрытие модального окна
function closeStatusModal() {
    const modal = document.getElementById('statusModal');
    modal.classList.remove('show');
    currentGameSlug = null;
    selectedStatus = null;
}

// Получение текущего статуса игры из загруженных данных
function getCurrentGameStatus(gameSlug) {
    const gameCards = document.querySelectorAll('.user-game-card');
    for (let card of gameCards) {
        const titleElement = card.querySelector('.user-game-title');
        if (titleElement && titleElement.getAttribute('data-slug') === gameSlug) {
            const statusElement = card.querySelector('.user-game-status');
            // Определяем статус по CSS классу
            if (statusElement.classList.contains('completed')) return 'COMPLETED';
            if (statusElement.classList.contains('playing')) return 'PLAYING';
            if (statusElement.classList.contains('plan')) return 'PLAN_TO_PLAY';
        }
    }
    return null;
}

// Обновление счетчиков при изменении статуса
function updateStatsAfterStatusChange(gameSlug, oldStatus, newStatus) {
    if (oldStatus === newStatus) return;
    
    const counters = {
        total: document.querySelector('.stat-card:nth-child(1) .stat-value'),
        completed: document.querySelector('.stat-card:nth-child(2) .stat-value'),
        playing: document.querySelector('.stat-card:nth-child(3) .stat-value'),
        plan: document.querySelector('.stat-card:nth-child(4) .stat-value')
    };
    
    // Уменьшаем счетчик старого статуса
    if (oldStatus === 'COMPLETED') {
        const currentValue = parseInt(counters.completed.textContent);
        updateCounterValue(counters.completed, currentValue - 1);
    } else if (oldStatus === 'PLAYING') {
        const currentValue = parseInt(counters.playing.textContent);
        updateCounterValue(counters.playing, currentValue - 1);
    } else if (oldStatus === 'PLAN_TO_PLAY') {
        const currentValue = parseInt(counters.plan.textContent);
        updateCounterValue(counters.plan, currentValue - 1);
    }
    
    // Увеличиваем счетчик нового статуса
    if (newStatus === 'COMPLETED') {
        const currentValue = parseInt(counters.completed.textContent);
        updateCounterValue(counters.completed, currentValue + 1);
    } else if (newStatus === 'PLAYING') {
        const currentValue = parseInt(counters.playing.textContent);
        updateCounterValue(counters.playing, currentValue + 1);
    } else if (newStatus === 'PLAN_TO_PLAY') {
        const currentValue = parseInt(counters.plan.textContent);
        updateCounterValue(counters.plan, currentValue + 1);
    }
}

// Обновление визуального статуса игры в карточке
function updateGameCardStatus(gameSlug, newStatus) {
    const gameCards = document.querySelectorAll('.user-game-card');
    for (let card of gameCards) {
        const titleElement = card.querySelector('.user-game-title');
        if (titleElement && titleElement.getAttribute('data-slug') === gameSlug) {
            const statusElement = card.querySelector('.user-game-status');
            
            // Убираем старые классы
            statusElement.classList.remove('completed', 'playing', 'plan');
            
            // Добавляем новый класс и текст
            const statusMap = {
                'COMPLETED': { class: 'completed', text: 'Завершено' },
                'PLAYING': { class: 'playing', text: 'Играю' },
                'PLAN_TO_PLAY': { class: 'plan', text: 'Планирую играть' }
            };
            
            const statusInfo = statusMap[newStatus];
            if (statusInfo) {
                statusElement.classList.add(statusInfo.class);
                statusElement.textContent = statusInfo.text;
                
                // Обновляем onclick с новым статусом
                const gameName = titleElement.textContent;
                statusElement.setAttribute('onclick', `openStatusModal('${gameSlug}', '${gameName}', '${newStatus}')`);
                
                // Добавляем визуальную анимацию обновления
                statusElement.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    statusElement.style.transform = 'scale(1)';
                }, 200);
            }
            break;
        }
    }
}

// Сохранение нового статуса
function saveGameStatus() {
    if (!currentGameSlug || !selectedStatus) {
        showNotification('error', 'Ошибка', 'Выберите статус игры');
        return;
    }
    
    const saveBtn = document.getElementById('saveStatusBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Сохранение...';
    
    // Получаем старый статус для возможного отката
    const oldStatus = getCurrentGameStatus(currentGameSlug);
    
    // Мгновенно обновляем интерфейс для отзывчивости
    updateStatsAfterStatusChange(currentGameSlug, oldStatus, selectedStatus);
    updateGameCardStatus(currentGameSlug, selectedStatus);
    
    fetch('/api/user/games/', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getJWTToken()
        },
        body: JSON.stringify({
            slug: currentGameSlug,
            status: selectedStatus
        })
    })
    .then(response => {
        if (response.ok) {
            showNotification('success', 'Успешно!', 'Статус игры обновлен');
            closeStatusModal();
            // Не нужно перезагружать список игр - все уже обновлено
        } else {
            // При ошибке откатываем изменения
            updateStatsAfterStatusChange(currentGameSlug, selectedStatus, oldStatus);
            updateGameCardStatus(currentGameSlug, oldStatus);
            return response.json().then(data => {
                throw new Error(data.error || 'Не удалось обновить статус');
            });
        }
    })
    .catch(error => {
        console.error('Ошибка при обновлении статуса:', error);
        showNotification('error', 'Ошибка', error.message || 'Не удалось обновить статус игры');
    })
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Сохранить';
    });
}

// Инициализация обработчиков для опций статуса
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.status-option').forEach(option => {
        option.addEventListener('click', function() {
            // Убираем выделение с других опций
            document.querySelectorAll('.status-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Выделяем выбранную опцию
            this.classList.add('selected');
            selectedStatus = this.getAttribute('data-status');
        });
    });
    
    // Закрытие модального окна по Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeStatusModal();
        }
    });
});

function navigateToGamePage(slug) {
    // Прямой редирект на страницу игры
    window.location.href = `/profile/game/${encodeURIComponent(slug)}/`;
}

// ===== ФУНКЦИИ ДЛЯ РЕКОМЕНДАЦИЙ =====

// Загрузка рекомендаций
function fetchRecommendations() {
    const container = document.getElementById('recommendationsContainer');
    const token = getJWTToken();
    
    if (!token) {
        container.innerHTML = `
            <div class="recommendations-empty">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Невозможно загрузить рекомендации</p>
                <p>Необходимо перезайти в аккаунт</p>
            </div>
        `;
        return;
    }
    
    // Показываем индикатор загрузки
    container.innerHTML = `
        <div class="recommendations-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Загружаем рекомендации...</p>
        </div>
    `;
    
    fetch('/api/user/recomended/', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data && data.length > 0) {
            renderRecommendations(data);
        } else {
            container.innerHTML = `
                <div class="recommendations-empty">
                    <i class="fas fa-gamepad"></i>
                    <p>Рекомендации не найдены</p>
                    <p>Добавьте игры в коллекцию для получения персонализированных рекомендаций</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Ошибка загрузки рекомендаций:', error);
        container.innerHTML = `
            <div class="recommendations-empty">
                <i class="fas fa-exclamation-circle"></i>
                <p>Ошибка загрузки рекомендаций</p>
                <p>Попробуйте обновить страницу</p>
            </div>
        `;
    });
}

// Отображение рекомендаций
function renderRecommendations(games) {
    const container = document.getElementById('recommendationsContainer');
    container.innerHTML = '';
    
    // Ограничиваем до 10 игр и показываем по 2 в ряд
    const limitedGames = games.slice(0, 10);
    
    limitedGames.forEach(game => {
        const card = createRecommendationCard(game);
        container.appendChild(card);
    });
}

// Создание карточки рекомендации
function createRecommendationCard(game) {
    const card = document.createElement('div');
    card.className = 'recommendation-card';
    card.setAttribute('data-game-slug', game.slug);
    
    // Клик по карточке ведет на страницу игры
    card.addEventListener('click', function(e) {
        if (!e.target.closest('.recommendation-add-btn')) {
            navigateToGamePage(game.slug);
        }
    });
    
    const rating = game.metacritic || game.rating || 0;
    const imageUrl = game.background_image || game.logo || '/static/images/no-image.jpg';
    
    card.innerHTML = `
        <img class="recommendation-image" src="${imageUrl}" alt="${game.name}" />
        <button class="recommendation-add-btn" onclick="addRecommendationToCollection('${game.slug}', event)" title="Добавить в коллекцию">
            <i class="fas fa-plus"></i>
        </button>
        <div class="recommendation-content">
            <h3 class="recommendation-title">${game.name}</h3>
            <div class="recommendation-meta">
                ${rating > 0 ? `<span class="recommendation-rating">${Math.round(rating)}</span>` : ''}
                ${game.genres && game.genres.length > 0 ? 
                    `<span>${game.genres.slice(0, 2).map(g => g.name).join(', ')}</span>` : 
                    ''
                }
            </div>
        </div>
    `;
    
    return card;
}

// Добавление рекомендованной игры в коллекцию
function addRecommendationToCollection(slug, event) {
    if (event) {
        event.stopPropagation(); // Предотвращаем переход на страницу игры
    }
    
    const token = getJWTToken();
    
    if (!token) {
        showNotification('error', 'Ошибка авторизации', 'Необходимо перезайти в аккаунт');
        return;
    }
    
    // Находим карточку и показываем индикатор загрузки
    const card = document.querySelector(`[data-game-slug="${slug}"]`);
    const addBtn = card ? card.querySelector('.recommendation-add-btn') : null;
    
    if (addBtn) {
        addBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        addBtn.disabled = true;
    }
    
    fetch(`/api/game/${encodeURIComponent(slug)}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({addGame: true})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('success', 'Успешно!', 'Игра добавлена в коллекцию');
            
            // Обновляем счетчики
            updateStatsAfterGameAddition();
            
            // Обновляем список игр пользователя
            fetchUserGames();
            
            // Перезагружаем рекомендации
            setTimeout(() => {
                fetchRecommendations();
            }, 1000);
            
        } else if (data.code === 'game_exists') {
            showNotification('info', 'Информация', 'Игра уже есть в вашей коллекции');
        } else {
            showNotification('error', 'Ошибка', data.message || 'Не удалось добавить игру в коллекцию');
        }
    })
    .catch(error => {
        console.error('Ошибка при добавлении игры:', error);
        showNotification('error', 'Ошибка', 'Не удалось добавить игру в коллекцию');
    })
    .finally(() => {
        // Восстанавливаем кнопку
        if (addBtn) {
            addBtn.innerHTML = '<i class="fas fa-plus"></i>';
            addBtn.disabled = false;
        }
    });
}

// Обновляем функции добавления и удаления игр, чтобы они обновляли рекомендации
const originalAddGameToProfile = addGameToProfile;
addGameToProfile = function(slug) {
    originalAddGameToProfile(slug);
    // Перезагружаем рекомендации после добавления игры
    setTimeout(() => {
        fetchRecommendations();
    }, 1000);
};

const originalDeleteGameFromCollection = deleteGameFromCollection;
deleteGameFromCollection = function(slug) {
    originalDeleteGameFromCollection(slug);
    // Перезагружаем рекомендации после удаления игры
    setTimeout(() => {
        fetchRecommendations();
    }, 1000);
};
</script>
{% endblock %} 